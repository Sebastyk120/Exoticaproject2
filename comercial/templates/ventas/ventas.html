{% load custom_filters %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% if venta %}Editar Venta #{{ venta.id }}{% else %}Nueva Venta{% endif %}</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/ventas/ventas.css' %}">
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <i class="fas fa-shopping-cart"></i>
                {% if venta %}Venta #{{ venta.id }}{% else %}Nueva Venta{% endif %}
            </h1>
            <nav class="breadcrumb">
                <a href="{% url 'home' %}"><i class="fas fa-home"></i> Inicio</a> &gt;
                <a href="{% url 'comercial:lista_ventas' %}"><i class="fas fa-shopping-cart"></i> Ventas</a> &gt;
                <span>{% if venta %}Venta #{{ venta.id }}{% else %}Nueva Venta{% endif %}</span>
            </nav>
        </header>

        <!-- Añadir contenedor para notificaciones -->
        <div id="notifications-container">
            {% if messages %}
                {% for message in messages %}
                    <div class="notification {% if message.tags %}{{ message.tags }}{% endif %}">
                        <span class="notification-message">{{ message }}</span>
                        <button type="button" class="close-notification">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="main-content">
            <!-- Sale Information -->
            <section class="order-info">
                <div class="section-header">
                    <h2><i class="fas fa-info-circle"></i> Información de la Venta</h2>
                    <div class="action-buttons">
                        <button type="button" id="guardar-todo-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Venta
                        </button>
                        {% if venta %}
                            <button type="button" id="generar-factura-btn" class="btn btn-success">
                                <i class="fas fa-file-invoice"></i> Generar Factura
                            </button>
                        {% endif %}
                    </div>
                </div>
                <form id="sale-form" method="post" action="{% if venta %}{% url 'comercial:guardar_venta' venta.id %}{% else %}{% url 'comercial:guardar_venta' %}{% endif %}">
                    {% csrf_token %}
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cliente">Cliente:</label>
                            <select id="cliente" name="cliente" required>
                                <option value="">Seleccionar Cliente</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" {% if venta and venta.cliente.id == cliente.id %}selected{% endif %}>
                                        {{ cliente.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="pedidos">Pedidos: <span class="required">*</span></label>
                            <div class="pedidos-input-container">
                                <button type="button" id="open-pedidos-modal" class="btn btn-select">
                                    <span id="pedidos-selected-text">Seleccionar pedidos asociados a esta venta</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="pedidos-selected-count" class="selected-count">0 seleccionados</div>
                            </div>
                            <div id="pedidos-error" class="field-error" style="display: none;">
                                Debe seleccionar al menos un pedido
                            </div>
                        </div>

                        <!-- Modal de selección de pedidos -->
                        <div id="pedidos-modal" class="modal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>Seleccionar Pedidos</h3>
                                    <button type="button" class="close-modal">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="pedidos-container">
                                        {% for pedido in ultimos_pedidos %}
                                            <div class="pedido-option {% if venta and pedido in venta.pedidos.all %}assigned{% endif %}">
                                                <input type="checkbox" 
                                                       id="pedido_{{ pedido.id }}" 
                                                       name="pedidos" 
                                                       value="{{ pedido.id }}"
                                                       {% if venta and pedido in venta.pedidos.all %}checked{% endif %}>
                                                <label for="pedido_{{ pedido.id }}">
                                                    <span class="pedido-date">{{ pedido.fecha_entrega|date:"d/m/Y" }}</span>
                                                    <span class="pedido-awb">AWB: {{ pedido.awb|default:"Sin AWB" }}</span>
                                                    <span class="pedido-exportador">Exportador: {{ pedido.exportador.nombre|default:"Sin exportador" }}</span>
                                                    {% if venta and pedido in venta.pedidos.all %}
                                                        <span class="pedido-status">(Asignado a esta venta)</span>
                                                    {% endif %}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" id="confirm-pedidos" class="btn btn-primary">Confirmar</button>
                                    <button type="button" class="btn btn-cancel close-modal">Cancelar</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="fecha_entrega">Fecha de Emision Factura/Entrega:</label>
                            <input type="date" id="fecha_entrega" name="fecha_entrega" value="{{ venta.fecha_entrega|date:'Y-m-d' }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="numero_nc">Número Abono/Reclamación:</label>
                            <input type="text" id="numero_nc" name="numero_nc" value="{{ venta.numero_nc|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="observaciones">Observaciones:</label>
                            <textarea id="observaciones" name="observaciones">{{ venta.observaciones|default:'' }}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="porcentaje_iva">% IVA:</label>
                            <input type="number" id="porcentaje_iva" name="porcentaje_iva" step="0.01" min="0" 
                                   value="{{ venta.porcentaje_iva|decimal_point_format }}" required>
                        </div>
                    </div>
                    
                    <div class="calculated-fields">
                        {% if venta %}
                            <div class="calc-field">
                                <span class="label">Semana:</span>
                                <span class="value">{{ venta.semana }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Fecha Vencimiento:</span>
                                <span class="value">{{ venta.fecha_vencimiento|date:"d/m/Y" }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Número Factura:</span>
                                <span class="value">{{ venta.numero_factura|default:"Pendiente" }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Cajas:</span>
                                <span class="value">{{ venta.total_cajas_pedido|default:0 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Subtotal Factura :</span>
                                <span class="value">{{ venta.subtotal_factura|default:0|format_currency_eur }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">IVA {{ venta.porcentaje_iva|default:"4" }}% :</span>
                                <span class="value">{{ venta.iva|default:0|format_currency_eur }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Factura :</span>
                                <span class="value">{{ venta.valor_total_factura_euro|default:0|format_currency_eur }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Abono Iva Incluido :</span>
                                <span class="value">{{ venta.valor_total_abono_euro|default:0|format_currency_eur }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Monto Pendiente :</span>
                                <span class="value">{{ venta.monto_pendiente|default:0|format_currency_eur }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Pagado:</span>
                                <span class="value payment-status {% if venta.pagado %}paid{% else %}pending{% endif %}">
                                    {{ venta.pagado|yesno:"Sí,No" }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </form>
            </section>
            
            <!-- Sale Details -->
            {% if venta %}
                <section class="order-details">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Detalles de la Venta</h2>
                        <div class="action-buttons">
                            <button id="add-detail-btn" class="btn btn-success">
                                <i class="fas fa-plus"></i> Agregar Detalle
                            </button>
                        </div>
                    </div>
                    
                    <div id="details-container">
                        <!-- Batch Details Form -->
                        <form id="batch-details-form" method="post" action="{% url 'comercial:guardar_detalles_batch' venta.id %}">
                            {% csrf_token %}
                            
                            <div id="new-details-container">
                                <!-- Aquí se añadirán dinámicamente los nuevos detalles -->
                            </div>
                            
                            <table id="details-table" class="details-table">
                                <thead>
                                    <tr>
                                        <th>Presentación</th>
                                        <th>Cajas Enviadas</th>
                                        <th>Valor Caja €</th>
                                        <th>No Cajas Abono</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for detalle in detalles %}
                                    <tr class="detail-row" data-id="{{ detalle.id }}">
                                        <td>
                                            <select name="detalle_{{ detalle.id }}_presentacion" required>
                                                {% for presentacion in presentaciones %}
                                                    <option value="{{ presentacion.id }}" {% if detalle.presentacion and detalle.presentacion.id == presentacion.id %}selected{% endif %}>
                                                        {{ presentacion.fruta.nombre }} - {{ presentacion.kilos }} Kg
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_cajas_enviadas" 
                                                   value="{{ detalle.cajas_enviadas|default:'0' }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_valor_x_caja_euro" 
                                                   value="{{ detalle.valor_x_caja_euro_str|default:detalle.valor_x_caja_euro|default:'0.00' }}" min="0" step="0.01">
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_no_cajas_abono" 
                                                   value="{{ detalle.no_cajas_abono_str|default:detalle.no_cajas_abono|default:'0.0' }}" min="0" step="0.1">
                                        </td>
                                        <td class="actions-cell">
                                            <button type="button" class="btn-icon btn-delete" onclick="removeDetailRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            
                            <div class="empty-state" {% if detalles %}style="display:none"{% endif %}>
                                <p>No hay detalles para esta venta. Haga clic en "Agregar Detalle" para añadir uno.</p>
                            </div>
                        </form>
                        
                        <!-- Template for new detail row -->
                        <template id="new-detail-row-template">
                            <tr class="detail-row new-detail">
                                <td>
                                    <select name="new_INDEX_presentacion" required>
                                        <option value="">Seleccionar Presentación</option>
                                        {% for presentacion in presentaciones %}
                                            <option value="{{ presentacion.id }}">
                                                {{ presentacion.fruta.nombre }} - {{ presentacion.kilos }} Kg
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="new_INDEX_cajas_enviadas" value="0" min="0">
                                </td>
                                <td>
                                    <input type="number" name="new_INDEX_valor_x_caja_euro" value="0" min="0" step="0.01">
                                </td>
                                <td>
                                    <input type="number" name="new_INDEX_no_cajas_abono" value="0" min="0" step="0.1">
                                </td>
                                <td class="actions-cell">
                                    <button type="button" class="btn-icon btn-delete" onclick="removeDetailRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </div>
                </section>
            {% endif %}
        </div>
    </div>

    <script>
        // Variables globales
        let newDetailCounter = 0;
        const clienteId = {% if venta.cliente %}{{ venta.cliente.id }}{% else %}null{% endif %};
        // Objeto para rastrear detalles marcados para eliminación
        const deletedDetails = {};
        
        function showNewDetailForm() {
            // Añadir una nueva fila al inicio de la tabla
            addNewDetailRow();
            
            // Ocultar mensaje de estado vacío
            document.querySelector('.empty-state').style.display = 'none';
            
            // Mostrar la tabla si está oculta
            document.getElementById('details-table').style.display = 'table';
        }
        
        function addNewDetailRow() {
            // Crear nueva fila a partir de la plantilla
            const template = document.getElementById('new-detail-row-template');
            const newRow = document.importNode(template.content, true);
            
            // Actualizar índices en los campos
            newRow.querySelectorAll('[name*="INDEX"]').forEach(field => {
                field.name = field.name.replace('INDEX', newDetailCounter);
            });
            
            // Añadir la fila al inicio de la tabla
            const tableBody = document.querySelector('#details-table tbody');
            tableBody.insertBefore(newRow, tableBody.firstChild);
            
            // Get the newly added row element
            const addedRow = tableBody.querySelector('tr:first-child');
            console.log("New row added:", addedRow);
            
            // Apply handleZeroFields to the new row
            handleZeroFields(addedRow);
            
            newDetailCounter++;
        }
        
        function removeDetailRow(button) {
            const row = button.closest('.detail-row');
            const detailId = row.dataset.id;
            
            if (detailId) {
                // Si es un detalle existente, agregar un campo oculto para marcarlo como eliminado
                const form = document.getElementById('batch-details-form');
                const deleteField = document.createElement('input');
                deleteField.type = 'hidden';
                deleteField.name = 'delete_detail_ids';
                deleteField.value = detailId;
                form.appendChild(deleteField);
                
                // Guardar la información sobre el detalle eliminado para considerarlo al validar stock
                const presentacionSelect = row.querySelector('select[name$="_presentacion"]');
                const cajasEnviadasInput = row.querySelector('input[name$="_cajas_enviadas"]');
                
                if (presentacionSelect && cajasEnviadasInput) {
                    const presentacionId = presentacionSelect.value;
                    const cajas = parseInt(cajasEnviadasInput.value) || 0;
                    
                    if (!deletedDetails[presentacionId]) {
                        deletedDetails[presentacionId] = 0;
                    }
                    
                    // Acumular las cajas liberadas para esta presentación
                    deletedDetails[presentacionId] += cajas;
                    console.log(`Stock liberado: ${cajas} cajas de presentación ${presentacionId}`);
                }
            }
            
            // Eliminar la fila
            row.remove();
            
            // Mostrar mensaje de estado vacío si no hay filas
            if (document.querySelectorAll('#details-table tbody tr').length === 0) {
                document.querySelector('.empty-state').style.display = 'block';
                document.getElementById('details-table').style.display = 'none';
            }
        }
        
        // Función para manejar los campos con valor cero
        function handleZeroFields(element) {
            // Seleccionar todos los campos numéricos
            const numericInputs = element.querySelectorAll('input[type="number"]');
            
            numericInputs.forEach(input => {
                // Evento focus - Vaciar cuando el valor es 0
                input.addEventListener('focus', function() {
                    // Verificar si el valor actual es 0, 0.0, 0.00, etc.
                    const value = parseFloat(this.value) || 0;
                    if (value === 0) {
                        this.value = '';
                    }
                });
                
                // Evento blur - Restaurar 0 si se deja vacío
                input.addEventListener('blur', function() {
                    if (this.value === '' || this.value === null) {
                        // Usar el paso (step) del input para determinar el formato
                        // Si tiene decimales, mostrar con decimales, sino entero
                        const step = parseFloat(this.getAttribute('step') || 1);
                        if (step < 1) {
                            // Es un campo decimal
                            const decimals = step.toString().split('.')[1].length;
                            this.value = (0).toFixed(decimals);
                        } else {
                            // Es un campo entero
                            this.value = '0';
                        }
                    }
                });
            });
        }
        
        // Función para cargar precios automáticamente
        function cargarPrecioPresentacion(selectElement) {
            const presentacionId = selectElement.value;
            const row = selectElement.closest('.detail-row');
            const valorCajaInput = row.querySelector('[name$="_valor_x_caja_euro"]');
            
            if (!presentacionId || !clienteId) return;
            
            // Hacer la petición AJAX para obtener el precio
            fetch(`/comercial/obtener-precio-presentacion/${presentacionId}/${clienteId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.precio) {
                        valorCajaInput.value = data.precio;
                    }
                })
                .catch(error => console.error('Error al cargar el precio:', error));
        }
        
        // Función para mostrar notificación
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notifications-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="notification-message">${message}</span>
                <button type="button" class="close-notification">&times;</button>
            `;
            
            container.appendChild(notification);
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
            
            // Configurar botón de cerrar
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.remove();
            });
        }

        // Actualizar el manejo de formularios para usar las notificaciones
        document.getElementById('sale-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Mostrar notificación de validación
            showNotification('Validando datos...', 'info');
            
            try {
                const isValid = await validarTodosLosStocks();
                
                if (!isValid) {
                    showNotification('Por favor, corrija los errores antes de guardar', 'error');
                    return;
                }
                
                // Si todo está válido, enviar el formulario
                this.submit();
            } catch (error) {
                console.error('Error durante la validación:', error);
                showNotification('Error durante la validación. Por favor, intente nuevamente.', 'error');
            }
        });

        // Función para guardar la venta y sus detalles
        async function guardarVentaYDetalles() {
            try {
                // Mostrar notificación de validación
                showNotification('Validando datos...', 'info');
                
                // Validar todos los datos antes de proceder
                const isValid = await validarTodosLosStocks();
                
                if (!isValid) {
                    showNotification('Por favor, corrija los errores antes de guardar', 'error');
                    return;
                }
                
                // Mostrar notificación de guardado
                showNotification('Guardando cambios...', 'info');
                
                // Guardar la venta principal
                const saleForm = document.getElementById('sale-form');
                const saleFormData = new FormData(saleForm);
                
                const saleResponse = await fetch(saleForm.action, {
                    method: 'POST',
                    body: saleFormData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest' // Añadir este encabezado
                    }
                });
                
                if (!saleResponse.ok) {
                    throw new Error('Error al guardar la venta');
                }
                
                // Intentar parsear la respuesta como JSON con manejo de errores
                let saleData;
                try {
                    saleData = await saleResponse.json();
                } catch (parseError) {
                    console.error('Error al procesar la respuesta JSON:', parseError);
                    throw new Error('La respuesta del servidor no tiene el formato esperado');
                }
                
                if (!saleData || !saleData.success) {
                    throw new Error(saleData?.message || 'Error al guardar la venta');
                }
                
                // Si es una venta nueva, actualizar la URL
                if (saleData.venta_id && !{{ venta.id|default:0 }}) {
                    window.history.pushState({}, '', `/comercial/ventas/${saleData.venta_id}/`);
                }
                
                // Si hay un formulario de detalles (ya existe la venta), guardarlos también
                if (document.getElementById('batch-details-form')) {
                    // Guardar los detalles
                    const detailsForm = document.getElementById('batch-details-form');
                    const detailsFormData = new FormData(detailsForm);
                    
                    const detailsResponse = await fetch(detailsForm.action, {
                        method: 'POST',
                        body: detailsFormData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest' // También añadir aquí
                        }
                    });
                    
                    if (!detailsResponse.ok) {
                        throw new Error('Error al guardar los detalles');
                    }
                }
                
                // Mostrar notificación de éxito
                showNotification('Cambios guardados correctamente', 'success');
                
                // Recargar la página para mostrar los cambios actualizados
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al guardar los cambios: ' + error.message, 'error');
            }
        }

        // Función para guardar solo los detalles
        async function guardarSoloDetalles() {
            try {
                // Mostrar notificación de validación
                showNotification('Validando datos...', 'info');
                
                // Validar todos los datos antes de proceder
                const isValid = await validarTodosLosStocks();
                
                if (!isValid) {
                    showNotification('Por favor, corrija los errores antes de guardar', 'error');
                    return;
                }
                
                // Mostrar notificación de guardado
                showNotification('Guardando detalles...', 'info');
                
                // Guardar los detalles
                const detailsForm = document.getElementById('batch-details-form');
                const detailsFormData = new FormData(detailsForm);
                
                const detailsResponse = await fetch(detailsForm.action, {
                    method: 'POST',
                    body: detailsFormData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest' // Añadir este encabezado
                    }
                });
                
                if (!detailsResponse.ok) {
                    throw new Error('Error al guardar los detalles');
                }
                
                // Mostrar notificación de éxito
                showNotification('Detalles guardados correctamente', 'success');
                
                // Limpiar el registro de eliminaciones después de guardar
                Object.keys(deletedDetails).forEach(key => delete deletedDetails[key]);
                
                // Recargar la página para mostrar los cambios
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al guardar los detalles: ' + error.message, 'error');
            }
        }

        // Actualizar el manejo del formulario principal para guardar todo
        async function guardarTodo() {
            try {
                // Mostrar notificación de validación
                showNotification('Validando datos...', 'info');
                
                // Validar todos los datos antes de proceder
                const isValid = await validarTodosLosStocks();
                
                if (!isValid) {
                    showNotification('Por favor, corrija los errores antes de guardar', 'error');
                    return;
                }
                
                // Mostrar notificación de guardado
                showNotification('Guardando cambios...', 'info');
                
                // Guardar la venta principal
                const saleForm = document.getElementById('sale-form');
                const saleFormData = new FormData(saleForm);
                
                const saleResponse = await fetch(saleForm.action, {
                    method: 'POST',
                    body: saleFormData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest' // Añadir este encabezado para que Django reconozca que es AJAX
                    }
                });
                
                if (!saleResponse.ok) {
                    throw new Error('Error al guardar la venta');
                }
                
                // Intentar parsear la respuesta como JSON con manejo de errores
                let saleData;
                try {
                    saleData = await saleResponse.json();
                } catch (parseError) {
                    console.error('Error al procesar la respuesta JSON:', parseError);
                    throw new Error('La respuesta del servidor no tiene el formato esperado');
                }
                
                if (!saleData || !saleData.success) {
                    throw new Error(saleData?.message || 'Error al guardar la venta');
                }
                
                // Si es una venta nueva, actualizar la URL
                if (saleData.venta_id && !{{ venta.id|default:0 }}) {
                    window.history.pushState({}, '', `/comercial/ventas/${saleData.venta_id}/`);
                }
                
                // Si hay un formulario de detalles (ya existe la venta), guardarlos también
                if (document.getElementById('batch-details-form')) {
                    // Guardar los detalles
                    const detailsForm = document.getElementById('batch-details-form');
                    const detailsFormData = new FormData(detailsForm);
                    
                    const detailsResponse = await fetch(detailsForm.action, {
                        method: 'POST',
                        body: detailsFormData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'X-Requested-With': 'XMLHttpRequest' // También añadir aquí
                        }
                    });
                    
                    if (!detailsResponse.ok) {
                        throw new Error('Error al guardar los detalles');
                    }
                }
                
                // Mostrar notificación de éxito
                showNotification('Cambios guardados correctamente', 'success');
                
                // Recargar la página para mostrar los cambios actualizados
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al guardar los cambios: ' + error.message, 'error');
            }
        }

        // Mostrar notificaciones existentes al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar notificaciones existentes
            const notifications = document.querySelectorAll('.notification');
            notifications.forEach(notification => {
                const message = notification.querySelector('.notification-message').textContent;
                const type = notification.classList.contains('error') ? 'error' : 
                            notification.classList.contains('warning') ? 'warning' : 
                            notification.classList.contains('info') ? 'info' : 'success';
                showNotification(message, type);
            });

            // Validar valores iniciales de caja
            document.querySelectorAll('input[name$="_valor_x_caja_euro"]').forEach(input => {
                validarValorCaja(input);
            });

            // Aplicar manejo de campos con valor cero a todos los campos numéricos existentes
            handleZeroFields(document);
            console.log("Zero field handling has been applied to all existing numeric inputs");

            // Evento para agregar detalle
            const addDetailBtn = document.getElementById('add-detail-btn');
            if (addDetailBtn) {
                addDetailBtn.addEventListener('click', showNewDetailForm);
            }
            
            // Configurar el botón para guardar todo
            document.getElementById('guardar-todo-btn').addEventListener('click', guardarTodo);
            
            // Mostrar/ocultar tabla según si hay elementos
            const detailsTable = document.getElementById('details-table');
            const emptyState = document.querySelector('.empty-state');
            
            if (detailsTable && emptyState) {
                if (document.querySelectorAll('#details-table tbody tr').length === 0) {
                    emptyState.style.display = 'block';
                    detailsTable.style.display = 'none';
                }
            }
            
            // Añadir evento para detectar cambios en selects de presentación
            document.addEventListener('change', function(e) {
                if (e.target.tagName === 'SELECT' && (e.target.name.includes('presentacion'))) {
                    cargarPrecioPresentacion(e.target);
                }
            });
            
            // Añadir eventos a botones de cerrar notificaciones existentes
            document.querySelectorAll('.close-notification').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.notification').remove();
                });
            });

            // Añadir evento al botón de generar factura
            const generarFacturaBtn = document.getElementById('generar-factura-btn');
            if (generarFacturaBtn) {
                generarFacturaBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        // Primero guardar todos los datos
                        showNotification('Guardando datos antes de generar factura...', 'info');
                        await guardarTodo();
                        
                        // Obtener el ID de la venta
                        const ventaId = {{ venta.id|default:0 }};
                        if (!ventaId) {
                            throw new Error('No se encontró el ID de la venta');
                        }
                        
                        // Redirigir a la generación de factura
                        showNotification('Generando factura...', 'info');
                        window.location.href = `/comercial/ventas/${ventaId}/generar-factura/`;
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('Error al generar factura: ' + error.message, 'error');
                    }
                });
            }

            // Funcionalidad del modal de pedidos
            const modal = document.getElementById('pedidos-modal');
            const openModalBtn = document.getElementById('open-pedidos-modal');
            const closeModalBtns = document.querySelectorAll('.close-modal');
            const confirmBtn = document.getElementById('confirm-pedidos');
            const pedidosSelectedText = document.getElementById('pedidos-selected-text');
            const pedidosSelectedCount = document.getElementById('pedidos-selected-count');
            const pedidosError = document.getElementById('pedidos-error');

            // Función para actualizar el texto del botón con los pedidos seleccionados
            function updateSelectedPedidosText() {
                const selectedPedidos = document.querySelectorAll('input[name="pedidos"]:checked');
                const selectedCount = selectedPedidos.length;
                
                pedidosSelectedCount.textContent = `${selectedCount} seleccionado${selectedCount > 1 ? 's' : ''}`;
                
                if (selectedCount > 0) {
                    const dates = Array.from(selectedPedidos).map(pedido => {
                        const label = pedido.nextElementSibling;
                        return label.querySelector('.pedido-date').textContent;
                    });
                    pedidosSelectedText.textContent = dates.join(', ');
                } else {
                    pedidosSelectedText.textContent = 'Seleccionar pedidos';
                }
            }

            // Actualizar el texto inicial si hay pedidos seleccionados
            updateSelectedPedidosText();

            // Abrir modal
            openModalBtn.addEventListener('click', function() {
                modal.style.display = 'block';
            });

            // Cerrar modal
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            });

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // Confirmar selección
            confirmBtn.addEventListener('click', function() {
                const selectedPedidos = document.querySelectorAll('input[name="pedidos"]:checked');
                const selectedCount = selectedPedidos.length;
                
                if (selectedCount === 0) {
                    pedidosError.style.display = 'block';
                    return;
                }

                pedidosError.style.display = 'none';
                updateSelectedPedidosText();
                modal.style.display = 'none';
            });

            // Validar antes de enviar el formulario
            document.getElementById('sale-form').addEventListener('submit', function(e) {
                const selectedPedidos = document.querySelectorAll('input[name="pedidos"]:checked');
                if (selectedPedidos.length === 0) {
                    e.preventDefault();
                    pedidosError.style.display = 'block';
                    openModalBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        });

        // Función para validar stock y mostrar error
        async function validarStock(presentacionId, cajasEnviadas, inputElement) {
            // Si el campo está vacío (durante edición), tratar como 0
            if (inputElement.value === '') {
                cajasEnviadas = 0;
            }
            
            if (!presentacionId || !cajasEnviadas) return true;
            
            try {
                // Obtener el ID del detalle si existe (para ediciones)
                const row = inputElement.closest('.detail-row');
                const detalleId = row.dataset.id;
                
                // Construir URL incluyendo el ID del detalle cuando está disponible
                let url = `/comercial/validar-stock/${presentacionId}/${cajasEnviadas}/`;
                if (detalleId) {
                    url += `?detalle_id=${detalleId}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) {
                    // Verificar si hay cajas liberadas por elementos eliminados de esta presentación
                    const cajasLiberadas = deletedDetails[presentacionId] || 0;
                    const stockDisponible = data.stock_disponible || 0;
                    const stockTotalDisponible = stockDisponible + cajasLiberadas;
                    
                    // Si hay suficientes cajas liberadas + disponibles, permitir la operación
                    if (stockTotalDisponible >= cajasEnviadas) {
                        // Hay suficiente stock considerando las eliminaciones pendientes
                        console.log(`Validación exitosa usando stock liberado: ${cajasEnviadas} <= ${stockDisponible} + ${cajasLiberadas}`);
                        
                        // Remover error si existe
                        const existingError = inputElement.parentElement.querySelector('.field-error');
                        if (existingError) {
                            existingError.remove();
                        }
                        inputElement.classList.remove('error');
                        return true;
                    } else {
                        // Mostrar error en el campo incluyendo información sobre el stock liberado
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'field-error';
                        errorDiv.textContent = `Stock insuficiente. Solo hay ${stockDisponible} cajas disponibles más ${cajasLiberadas} pendientes de liberar (total: ${stockTotalDisponible}).`;
                        
                        // Remover error anterior si existe
                        const existingError = inputElement.parentElement.querySelector('.field-error');
                        if (existingError) {
                            existingError.remove();
                        }
                        
                        // Agregar el nuevo error
                        inputElement.parentElement.appendChild(errorDiv);
                        inputElement.classList.add('error');
                        
                        return false;
                    }
                } else {
                    // Remover error si existe
                    const existingError = inputElement.parentElement.querySelector('.field-error');
                    if (existingError) {
                        existingError.remove();
                    }
                    inputElement.classList.remove('error');
                    return true;
                }
            } catch (error) {
                console.error('Error al validar stock:', error);
                return false;
            }
        }

        // Función para validar que No Cajas Abono no sea mayor que Cajas Enviadas
        function validarCajasAbono(row) {
            const cajasEnviadasInput = row.querySelector('input[name$="_cajas_enviadas"]');
            const noCajasAbonoInput = row.querySelector('input[name$="_no_cajas_abono"]');
            
            if (!cajasEnviadasInput || !noCajasAbonoInput) return true;
            
            // Manejar caso de campo vacío (temporalmente durante la edición)
            const cajasEnviadas = cajasEnviadasInput.value === '' ? 0 : parseFloat(cajasEnviadasInput.value) || 0;
            const noCajasAbono = noCajasAbonoInput.value === '' ? 0 : parseFloat(noCajasAbonoInput.value) || 0;
            
            if (noCajasAbono > cajasEnviadas) {
                // Mostrar error en el campo
                const errorDiv = document.createElement('div');
                errorDiv.className = 'field-error';
                errorDiv.textContent = `No puede haber más cajas de abono (${noCajasAbono}) que cajas enviadas (${cajasEnviadas})`;
                
                // Remover error anterior si existe
                const existingError = noCajasAbonoInput.parentElement.querySelector('.field-error');
                if (existingError) {
                    existingError.remove();
                }
                
                // Agregar el nuevo error
                noCajasAbonoInput.parentElement.appendChild(errorDiv);
                noCajasAbonoInput.classList.add('error');
                
                return false;
            } else {
                // Remover error si existe
                const existingError = noCajasAbonoInput.parentElement.querySelector('.field-error');
                if (existingError) {
                    existingError.remove();
                }
                noCajasAbonoInput.classList.remove('error');
                return true;
            }
        }

        // Función para validar todos los campos de cajas enviadas y abono
        async function validarTodosLosStocks() {
            const rows = document.querySelectorAll('.detail-row');
            let isValid = true;
            
            // Primero validar si hay cajas de abono
            let tieneCajasAbono = false;
            for (const row of rows) {
                const noCajasAbonoInput = row.querySelector('input[name$="_no_cajas_abono"]');
                if (noCajasAbonoInput) {
                    const noCajasAbono = parseFloat(noCajasAbonoInput.value) || 0;
                    if (noCajasAbono > 0) {
                        tieneCajasAbono = true;
                        break;
                    }
                }
            }
            
            // Si hay cajas de abono, validar el número NC/Reclamación
            if (tieneCajasAbono) {
                const numeroNcInput = document.getElementById('numero_nc');
                if (!numeroNcInput || !numeroNcInput.value.trim()) {
                    // Mostrar error en el campo
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'field-error';
                    errorDiv.textContent = 'El número NC/Reclamación es requerido cuando hay cajas de abono';
                    
                    // Remover error anterior si existe
                    const existingError = numeroNcInput.parentElement.querySelector('.field-error');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // Agregar el nuevo error
                    numeroNcInput.parentElement.appendChild(errorDiv);
                    numeroNcInput.classList.add('error');
                    
                    isValid = false;
                } else {
                    // Remover error si existe
                    const existingError = numeroNcInput.parentElement.querySelector('.field-error');
                    if (existingError) {
                        existingError.remove();
                    }
                    numeroNcInput.classList.remove('error');
                }
            }
            
            // Continuar con las validaciones existentes
            for (const row of rows) {
                const presentacionSelect = row.querySelector('select[name$="_presentacion"]');
                const cajasInput = row.querySelector('input[name$="_cajas_enviadas"]');
                
                if (presentacionSelect && cajasInput) {
                    const isValidStock = await validarStock(
                        presentacionSelect.value,
                        parseFloat(cajasInput.value) || 0,
                        cajasInput
                    );
                    if (!isValidStock) isValid = false;
                }
                
                // Validar cajas de abono
                if (!validarCajasAbono(row)) {
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        // Función para validar valor de caja
        function validarValorCaja(input) {
            const valor = parseFloat(input.value) || 0;
            if (valor === 0) {
                input.classList.add('zero-value');
            } else {
                input.classList.remove('zero-value');
            }
        }

        // Modificar el evento de cambio de cajas enviadas
        document.addEventListener('input', function(e) {
            if (e.target.name && e.target.name.endsWith('_cajas_enviadas')) {
                const row = e.target.closest('.detail-row');
                const presentacionSelect = row.querySelector('select[name$="_presentacion"]');
                if (presentacionSelect && presentacionSelect.value) {
                    // Usar parseFloat en lugar de parseInt para manejar valores vacíos correctamente
                    const cajasEnviadas = parseFloat(e.target.value) || 0;
                    validarStock(
                        presentacionSelect.value,
                        cajasEnviadas,
                        e.target
                    );
                }
                
                // Validar cajas de abono cuando cambian las cajas enviadas
                validarCajasAbono(row);
            }
            
            // Validar cajas de abono cuando cambian
            if (e.target.name && e.target.name.endsWith('_no_cajas_abono')) {
                const row = e.target.closest('.detail-row');
                validarCajasAbono(row);
            }

            // Validar valor de caja cuando cambia
            if (e.target.name && e.target.name.endsWith('_valor_x_caja_euro')) {
                validarValorCaja(e.target);
            }
        });
        
        // Modificar el evento de envío del formulario de detalles
        document.getElementById('batch-details-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Mostrar notificación de validación
            showNotification('Validando datos...', 'info');
                
            try {
                const isValid = await validarTodosLosStocks();
                
                if (!isValid) {
                    showNotification('Por favor, corrija los errores antes de guardar', 'error');
                    return;
                }
                
                // Si todo está válido, enviar el formulario
                this.submit();
            } catch (error) {
                console.error('Error durante la validación:', error);
                showNotification('Error durante la validación. Por favor, intente nuevamente.', 'error');
            }
        });

        // Agregar estilos CSS para los errores
        const style = document.createElement('style');
        style.textContent = `
            .field-error {
                color: #dc3545;
                font-size: 0.875rem;
                margin-top: 0.25rem;
                display: block;
            }
            input.error {
                border-color: #dc3545;
            }
            input.error:focus {
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>