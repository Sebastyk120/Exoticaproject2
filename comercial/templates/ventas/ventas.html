<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% if venta %}Editar Venta #{{ venta.id }}{% else %}Nueva Venta{% endif %}</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/ventas/ventas.css' %}">
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <i class="fas fa-shopping-cart"></i>
                {% if venta %}Venta #{{ venta.id }}{% else %}Nueva Venta{% endif %}
            </h1>
            <nav class="breadcrumb">
                <a href="{% url 'home' %}"><i class="fas fa-home"></i> Inicio</a> &gt;
                <a href="{% url 'comercial:lista_ventas' %}"><i class="fas fa-shopping-cart"></i> Ventas</a> &gt;
                <span>{% if venta %}Venta #{{ venta.id }}{% else %}Nueva Venta{% endif %}</span>
            </nav>
        </header>

        <!-- Añadir contenedor para notificaciones -->
        <div id="notifications-container">
            {% if messages %}
                {% for message in messages %}
                    <div class="notification {% if message.tags %}{{ message.tags }}{% endif %}">
                        <span class="notification-message">{{ message }}</span>
                        <button type="button" class="close-notification">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="main-content">
            <!-- Sale Information -->
            <section class="order-info">
                <div class="section-header">
                    <h2><i class="fas fa-info-circle"></i> Información de la Venta</h2>
                    <div class="action-buttons">
                        <button type="submit" form="sale-form" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Venta
                        </button>
                        {% if venta %}
                            <a href="{% url 'comercial:generar_factura' venta.id %}" class="btn btn-success">
                                <i class="fas fa-file-invoice"></i> Generar Factura
                            </a>
                        {% endif %}
                    </div>
                </div>
                <form id="sale-form" method="post" action="{% if venta %}{% url 'comercial:guardar_venta' venta.id %}{% else %}{% url 'comercial:guardar_venta' %}{% endif %}">
                    {% csrf_token %}
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cliente">Cliente:</label>
                            <select id="cliente" name="cliente" required>
                                <option value="">Seleccionar Cliente</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" {% if venta and venta.cliente.id == cliente.id %}selected{% endif %}>
                                        {{ cliente.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fecha_entrega">Fecha de Entrega:</label>
                            <input type="date" id="fecha_entrega" name="fecha_entrega" value="{{ venta.fecha_entrega|date:'Y-m-d' }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="numero_nc">Número NC/Reclamación:</label>
                            <input type="text" id="numero_nc" name="numero_nc" value="{{ venta.numero_nc|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="observaciones">Observaciones:</label>
                            <textarea id="observaciones" name="observaciones">{{ venta.observaciones|default:'' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="calculated-fields">
                        {% if venta %}
                            <div class="calc-field">
                                <span class="label">Semana:</span>
                                <span class="value">{{ venta.semana }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Fecha Vencimiento:</span>
                                <span class="value">{{ venta.fecha_vencimiento|date:"d/m/Y" }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Número Factura:</span>
                                <span class="value">{{ venta.numero_factura|default:"Pendiente" }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Cajas:</span>
                                <span class="value">{{ venta.total_cajas_pedido|default:0 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Subtotal Factura €:</span>
                                <span class="value">{{ venta.subtotal_factura|default:0|floatformat:2 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">IVA 4% €:</span>
                                <span class="value">{{ venta.iva|default:0|floatformat:2 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Factura €:</span>
                                <span class="value">{{ venta.valor_total_factura_euro|default:0|floatformat:2 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Abono €:</span>
                                <span class="value">{{ venta.valor_total_abono_euro|default:0|floatformat:2 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Monto Pendiente €:</span>
                                <span class="value">{{ venta.monto_pendiente|default:0|floatformat:2 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Pagado:</span>
                                <span class="value payment-status {% if venta.pagado %}paid{% else %}pending{% endif %}">
                                    {{ venta.pagado|yesno:"Sí,No" }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </form>
            </section>
            
            <!-- Sale Details -->
            {% if venta %}
                <section class="order-details">
                    <div class="section-header">
                        <h2><i class="fas fa-list"></i> Detalles de la Venta</h2>
                        <div class="action-buttons">
                            <button id="add-detail-btn" class="btn btn-success">
                                <i class="fas fa-plus"></i> Agregar Detalle
                            </button>
                            <button id="save-all-details-btn" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Todos
                            </button>
                        </div>
                    </div>
                    
                    <div id="details-container">
                        <!-- Batch Details Form -->
                        <form id="batch-details-form" method="post" action="{% url 'comercial:guardar_detalles_batch' venta.id %}">
                            {% csrf_token %}
                            
                            <div id="new-details-container">
                                <!-- Aquí se añadirán dinámicamente los nuevos detalles -->
                            </div>
                            
                            <table id="details-table" class="details-table">
                                <thead>
                                    <tr>
                                        <th>Presentación</th>
                                        <th>Cajas Enviadas</th>
                                        <th>Valor Caja €</th>
                                        <th>No Cajas Abono</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for detalle in detalles %}
                                    <tr class="detail-row" data-id="{{ detalle.id }}">
                                        <td>
                                            <select name="detalle_{{ detalle.id }}_presentacion" required>
                                                {% for presentacion in presentaciones %}
                                                    <option value="{{ presentacion.id }}" {% if detalle.presentacion and detalle.presentacion.id == presentacion.id %}selected{% endif %}>
                                                        {{ presentacion.fruta.nombre }} - {{ presentacion.kilos }} Kg
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_cajas_enviadas" 
                                                   value="{{ detalle.cajas_enviadas|default:'0' }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_valor_x_caja_euro" 
                                                   value="{{ detalle.valor_x_caja_euro_str|default:detalle.valor_x_caja_euro|default:'0.00' }}" min="0" step="0.01">
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_no_cajas_abono" 
                                                   value="{{ detalle.no_cajas_abono_str|default:detalle.no_cajas_abono|default:'0.0' }}" min="0" step="0.1">
                                        </td>
                                        <td class="actions-cell">
                                            <button type="button" class="btn-icon btn-delete" onclick="removeDetailRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            
                            <div class="empty-state" {% if detalles %}style="display:none"{% endif %}>
                                <p>No hay detalles para esta venta. Haga clic en "Agregar Detalle" para añadir uno.</p>
                            </div>
                        </form>
                        
                        <!-- Template for new detail row -->
                        <template id="new-detail-row-template">
                            <tr class="detail-row new-detail">
                                <td>
                                    <select name="new_INDEX_presentacion" required>
                                        <option value="">Seleccionar Presentación</option>
                                        {% for presentacion in presentaciones %}
                                            <option value="{{ presentacion.id }}">
                                                {{ presentacion.fruta.nombre }} - {{ presentacion.kilos }} Kg
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="new_INDEX_cajas_enviadas" value="0" min="0">
                                </td>
                                <td>
                                    <input type="number" name="new_INDEX_valor_x_caja_euro" value="0" min="0" step="0.01">
                                </td>
                                <td>
                                    <input type="number" name="new_INDEX_no_cajas_abono" value="0" min="0" step="0.1">
                                </td>
                                <td class="actions-cell">
                                    <button type="button" class="btn-icon btn-delete" onclick="removeDetailRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </div>
                    
                    {% if venta %}
                    <div class="fiscal-info">
                        <div class="fiscal-row">
                            <span class="fiscal-label">Subtotal:</span>
                            <span class="fiscal-value">€ {{ venta.subtotal_factura|default:0|floatformat:2 }}</span>
                        </div>
                        <div class="fiscal-row">
                            <span class="fiscal-label">IVA (4%):</span>
                            <span class="fiscal-value">€ {{ venta.iva|default:0|floatformat:2 }}</span>
                        </div>
                        <div class="fiscal-row">
                            <span class="fiscal-label">Total Factura:</span>
                            <span class="fiscal-value total-value">€ {{ venta.valor_total_factura_euro|default:0|floatformat:2 }}</span>
                        </div>
                        <div class="fiscal-row">
                            <span class="fiscal-label">Total Abono:</span>
                            <span class="fiscal-value">€ {{ venta.valor_total_abono_euro|default:0|floatformat:2 }}</span>
                        </div>
                        <div class="fiscal-row">
                            <span class="fiscal-label">Pendiente:</span>
                            <span class="fiscal-value">€ {{ venta.monto_pendiente|default:0|floatformat:2 }}</span>
                        </div>
                    </div>
                    {% endif %}
                </section>
            {% endif %}
        </div>
    </div>

    <script>
        // Variables globales
        let newDetailCounter = 0;
        const clienteId = {% if venta.cliente %}{{ venta.cliente.id }}{% else %}null{% endif %};
        
        function showNewDetailForm() {
            // Añadir una nueva fila al inicio de la tabla
            addNewDetailRow();
            
            // Ocultar mensaje de estado vacío
            document.querySelector('.empty-state').style.display = 'none';
            
            // Mostrar la tabla si está oculta
            document.getElementById('details-table').style.display = 'table';
        }
        
        function addNewDetailRow() {
            // Crear nueva fila a partir de la plantilla
            const template = document.getElementById('new-detail-row-template');
            const newRow = document.importNode(template.content, true);
            
            // Actualizar índices en los campos
            newRow.querySelectorAll('[name*="INDEX"]').forEach(field => {
                field.name = field.name.replace('INDEX', newDetailCounter);
            });
            
            // Añadir la fila al inicio de la tabla
            const tableBody = document.querySelector('#details-table tbody');
            tableBody.insertBefore(newRow, tableBody.firstChild);
            
            newDetailCounter++;
        }
        
        function removeDetailRow(button) {
            const row = button.closest('.detail-row');
            const detailId = row.dataset.id;
            
            if (detailId) {
                // Si es un detalle existente, agregar un campo oculto para marcarlo como eliminado
                const form = document.getElementById('batch-details-form');
                const deleteField = document.createElement('input');
                deleteField.type = 'hidden';
                deleteField.name = 'delete_detail_ids';
                deleteField.value = detailId;
                form.appendChild(deleteField);
            }
            
            // Eliminar la fila
            row.remove();
            
            // Mostrar mensaje de estado vacío si no hay filas
            if (document.querySelectorAll('#details-table tbody tr').length === 0) {
                document.querySelector('.empty-state').style.display = 'block';
                document.getElementById('details-table').style.display = 'none';
            }
        }
        
        // Función para cargar precios automáticamente
        function cargarPrecioPresentacion(selectElement) {
            const presentacionId = selectElement.value;
            const row = selectElement.closest('.detail-row');
            const valorCajaInput = row.querySelector('[name$="_valor_x_caja_euro"]');
            
            if (!presentacionId || !clienteId) return;
            
            // Hacer la petición AJAX para obtener el precio
            fetch(`/comercial/obtener-precio-presentacion/${presentacionId}/${clienteId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.precio) {
                        valorCajaInput.value = data.precio;
                    }
                })
                .catch(error => console.error('Error al cargar el precio:', error));
        }
        
        // Función para mostrar notificación
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notificacion = document.createElement('div');
            notificacion.className = `notification ${tipo}`;
            notificacion.innerHTML = `
                <span class="notification-message">${mensaje}</span>
                <button type="button" class="close-notification">&times;</button>
            `;
            
            const container = document.getElementById('notifications-container');
            container.appendChild(notificacion);
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                notificacion.classList.add('fade-out');
                setTimeout(() => notificacion.remove(), 500);
            }, 5000);
            
            // Configurar botón de cerrar
            notificacion.querySelector('.close-notification').addEventListener('click', function() {
                notificacion.remove();
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Evento para agregar detalle
            const addDetailBtn = document.getElementById('add-detail-btn');
            if (addDetailBtn) {
                addDetailBtn.addEventListener('click', showNewDetailForm);
            }
            
            // Evento para guardar todos los detalles
            const saveAllBtn = document.getElementById('save-all-details-btn');
            if (saveAllBtn) {
                saveAllBtn.addEventListener('click', function() {
                    document.getElementById('batch-details-form').submit();
                });
            }
            
            // Mostrar/ocultar tabla según si hay elementos
            const detailsTable = document.getElementById('details-table');
            const emptyState = document.querySelector('.empty-state');
            
            if (detailsTable && emptyState) {
                if (document.querySelectorAll('#details-table tbody tr').length === 0) {
                    emptyState.style.display = 'block';
                    detailsTable.style.display = 'none';
                }
            }
            
            // Añadir evento para detectar cambios en selects de presentación
            document.addEventListener('change', function(e) {
                if (e.target.tagName === 'SELECT' && (e.target.name.includes('presentacion'))) {
                    cargarPrecioPresentacion(e.target);
                }
            });
            
            // Añadir eventos a botones de cerrar notificaciones existentes
            document.querySelectorAll('.close-notification').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.notification').remove();
                });
            });
        });

        // Función para mostrar notificación
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notifications-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="notification-message">${message}</span>
                <button type="button" class="close-notification">&times;</button>
            `;
            
            container.appendChild(notification);
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
            
            // Configurar botón de cerrar
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.remove();
            });
        }

        // Actualizar el manejo de formularios para usar las notificaciones
        document.getElementById('sale-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Mostrar notificación de guardado
            showNotification('Guardando venta...', 'info');
            
            // Enviar el formulario
            this.submit();
        });
    </script>
</body>
</html>
