{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exotica Admin Panel</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/home.css' %}" rel="stylesheet">
    <link rel="icon" href="{% static 'img/favicon_dos.ico' %}" type="image/x-icon">
</head>
<body>
    <div class="app-container">
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="top-bar">
                <div class="brand">
                    <img src="{% static 'img/favicon_dos.ico' %}" alt="Exotica Logo" class="top-logo" onerror="this.src='https://via.placeholder.com/150x50?text=Exotica'">
                    <h1 class="brand-name">L&M Exotic Fruits</h1>
                </div>

                <div class="breadcrumb-wrapper d-none d-md-block">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                        </ol>
                    </nav>
                </div>

                <div class="top-actions">
                    <div class="dropdown me-3">
                        <button class="notification-btn" type="button" id="notificationsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span class="badge">3</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown">
                            <li><h6 class="dropdown-header">Notificaciones</h6></li>
                            <li><a class="dropdown-item" href="#">Nueva venta registrada</a></li>
                            <li><a class="dropdown-item" href="#">Llegada de importación</a></li>
                            <li><a class="dropdown-item" href="#">Actualización de precios</a></li>
                        </ul>
                    </div>

                    <div class="dropdown">
                        <button class="user-menu-btn" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="user-info d-none d-md-block">
                                <span class="user-name">{{ user.get_full_name|default:user.username }}</span>
                                <span class="user-role {% if user.is_superuser %}role-admin{% else %}role-staff{% endif %}">
                                    {% if user.is_superuser %}Administrator{% else %}Staff{% endif %}
                                </span>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog"></i> Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'autenticacion:logout' %}"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="content-wrapper">
                <div class="dashboard-header">
                    <h2>Panel Principal</h2>
                    <p class="text-muted">Bienvenido, {{ user.get_full_name|default:user.username }}. Aquí puedes acceder a todas las funcionalidades del sistema.</p>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="row">
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'comercial:clientes' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-comercial);">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Clientes</h3>
                                        <p class="stat-number">{{ client_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'presentaciones_view' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-productos);">
                                        <i class="fas fa-apple-alt"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Productos</h3>
                                        <p class="stat-number">{{ product_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'importacion:lista_pedidos' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-importacion);">
                                        <i class="fas fa-ship"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Importaciones</h3>
                                        <p class="stat-number">{{ import_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'comercial:lista_ventas' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-comercial-alt);">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Ventas</h3>
                                        <p class="stat-number">{{ sales_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'lista_cotizaciones' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-cotizaciones);">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Cotizaciones</h3>
                                        <p class="stat-number">{{ quote_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Utility Analysis Banner -->
                <div class="utility-banner mb-4">
                    <a href="{% url 'comercial:dashboard_utilidades' %}" class="text-decoration-none">
                        <div class="utility-card">
                            <div class="utility-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="utility-content">
                                <h3>Análisis de Utilidades</h3>
                                <p>Visualice reportes detallados de utilidades y rendimiento comercial</p>
                            </div>
                            <div class="utility-action">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Client Account Status Banner -->
                <div class="utility-banner mb-4">
                    <div class="text-decoration-none" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#clientStatusModal">
                        <div class="client-status-card">
                            <div class="client-status-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="client-status-content">
                                <h3>Estado de Cuenta de Clientes</h3>
                                <p>Consulte rápidamente el estado financiero de sus clientes</p>
                            </div>
                            <div class="client-status-action">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Status Modal -->
                <div class="modal fade" id="clientStatusModal" tabindex="-1" aria-labelledby="clientStatusModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="clientStatusModalLabel">
                                    <i class="fas fa-user-tie me-2"></i>Estado de Cuenta de Clientes
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <label for="clientSelect" class="form-label fw-bold">Seleccionar Cliente:</label>
                                        <select class="form-select" id="clientSelect" onchange="loadClientSummary()">
                                            <option value="">-- Seleccione un cliente --</option>
                                            {% for cliente in clientes %}
                                                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="clientSummaryContent" style="display: none;">
                                    <div class="client-summary-header mb-4">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-muted mb-1">Cliente seleccionado:</h6>
                                                <h4 id="selectedClientName" class="mb-0"></h4>
                                            </div>
                                            <div class="client-payment-terms">
                                                <span class="text-muted">Términos de pago:</span>
                                                <span id="clientPaymentTerms" class="fw-bold"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Summary Cards Row -->
                                    <div class="row g-3 mb-4">
                                        <div class="col-xl-2 col-lg-3 col-md-6">
                                            <div class="summary-card summary-card-primary">
                                                <div class="summary-icon">
                                                    <i class="fas fa-file-invoice-dollar"></i>
                                                </div>
                                                <div class="summary-data">
                                                    <h6>Total Facturado</h6>
                                                    <span id="totalFacturado" class="summary-number">€0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xl-2 col-lg-3 col-md-6">
                                            <div class="summary-card summary-card-info">
                                                <div class="summary-icon">
                                                    <i class="fas fa-boxes"></i>
                                                </div>
                                                <div class="summary-data">
                                                    <h6>Total Cajas</h6>
                                                    <span id="totalCajas" class="summary-number">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xl-2 col-lg-3 col-md-6">
                                            <div class="summary-card summary-card-warning">
                                                <div class="summary-icon">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </div>
                                                <div class="summary-data">
                                                    <h6>Rectificativas/Abonos</h6>
                                                    <span id="totalReclamaciones" class="summary-number">€0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xl-2 col-lg-3 col-md-6">
                                            <div class="summary-card summary-card-success">
                                                <div class="summary-icon">
                                                    <i class="fas fa-credit-card"></i>
                                                </div>
                                                <div class="summary-data">
                                                    <h6>Total Pagado</h6>
                                                    <span id="totalPagado" class="summary-number">€0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xl-2 col-lg-3 col-md-6">
                                            <div class="summary-card summary-card-balance" id="balanceCard">
                                                <div class="summary-icon">
                                                    <i class="fas fa-balance-scale"></i>
                                                </div>
                                                <div class="summary-data">
                                                    <h6>Saldo Actual</h6>
                                                    <span id="saldoActual" class="summary-number">€0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-xl-2 col-lg-3 col-md-6">
                                            <div class="summary-card summary-card-pending">
                                                <div class="summary-icon">
                                                    <i class="fas fa-clock"></i>
                                                </div>
                                                <div class="summary-data">
                                                    <h6>Facturas Pendientes</h6>
                                                    <span id="totalPendientes" class="summary-number">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Statistics -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="invoice-statistics">
                                                <h6 class="mb-3">
                                                    <i class="fas fa-chart-pie me-2"></i>Estadísticas de Facturas Pendientes
                                                </h6>
                                                <div class="row g-3">
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="stat-item stat-overdue">
                                                            <div class="stat-icon">
                                                                <i class="fas fa-exclamation-triangle"></i>
                                                            </div>
                                                            <div class="stat-content">
                                                                <span class="stat-label">Vencidas</span>
                                                                <span id="facturasVencidas" class="stat-value">0</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="stat-item stat-due-soon">
                                                            <div class="stat-icon">
                                                                <i class="fas fa-clock"></i>
                                                            </div>
                                                            <div class="stat-content">
                                                                <span class="stat-label">Próximas (≤7 días)</span>
                                                                <span id="facturasProximas" class="stat-value">0</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="stat-item stat-normal">
                                                            <div class="stat-icon">
                                                                <i class="fas fa-calendar-check"></i>
                                                            </div>
                                                            <div class="stat-content">
                                                                <span class="stat-label">Normales</span>
                                                                <span id="facturasNormales" class="stat-value">0</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-md-6">
                                                        <div class="stat-item stat-with-rectificative">
                                                            <div class="stat-icon">
                                                                <i class="fas fa-file-medical"></i>
                                                            </div>
                                                            <div class="stat-content">
                                                                <span class="stat-label">Con Rectificativas</span>
                                                                <span id="facturasConAbono" class="stat-value">0</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Pending Invoices Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="pending-invoices-section">
                                                <div class="pending-invoices-header">
                                                    <h6 class="mb-3">
                                                        <i class="fas fa-list-alt me-2"></i>Detalle de Facturas Pendientes
                                                    </h6>
                                                </div>
                                                <div id="pendingInvoicesContainer" class="pending-invoices-list">
                                                    <!-- Invoices will be populated here -->
                                                </div>
                                                <div id="noPendingInvoices" class="text-center text-muted py-4" style="display: none;">
                                                    <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                                                    <h5 class="text-success">¡Excelente!</h5>
                                                    <p class="mb-0">No hay facturas pendientes de pago</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="loadingSpinner" class="text-center" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="noClientSelected" class="text-center text-muted py-5">
                                    <i class="fas fa-user-plus fa-3x mb-3"></i>
                                    <p>Seleccione un cliente para ver su estado de cuenta</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <a id="viewFullStatusBtn" href="#" class="btn btn-primary" style="display: none;">
                                    <i class="fas fa-external-link-alt me-1"></i>Ver Estado Completo
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- App Categories -->
                <div class="app-categories">
                    <!-- Productos Category -->
                    <div class="category-section">
                        <div class="category-header productos-category">
                            <div class="category-icon">
                                <i class="fas fa-apple-alt"></i>
                            </div>
                            <h3>Gestión de Productos</h3>
                        </div>

                        <div class="app-grid">
                            <a href="{% url 'frutas_view' %}" class="app-card">
                                <div class="app-icon productos-bg">
                                    <i class="fas fa-lemon"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Frutas</h4>
                                    <p>Administre el catálogo de frutas</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'presentaciones_view' %}" class="app-card">
                                <div class="app-icon productos-bg">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Presentaciones</h4>
                                    <p>Gestione los formatos de presentación</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'lista_precios_importacion' %}" class="app-card">
                                <div class="app-icon productos-bg">
                                    <i class="fas fa-ship"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Precios de Importación</h4>
                                    <p>Consulte y actualice los precios de importación</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'lista_precios_ventas' %}" class="app-card">
                                <div class="app-icon productos-bg">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Precios de Venta</h4>
                                    <p>Administre los precios de venta</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Importación Category -->
                    <div class="category-section">
                        <div class="category-header importacion-category">
                            <div class="category-icon">
                                <i class="fas fa-ship"></i>
                            </div>
                            <h3>Gestión de Importaciones</h3>
                        </div>

                        <div class="app-grid">
                            <a href="{% url 'importacion:aduana_pdf' %}" class="app-card">
                                <div class="app-icon importacion-bg">
                                    <i class="fas fa-passport"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Aduana PDF</h4>
                                    <p>Procese documentos de aduana</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'importacion:carga_pdf' %}" class="app-card">
                                <div class="app-icon importacion-bg">
                                    <i class="fas fa-truck-loading"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Carga PDF</h4>
                                    <p>Procese documentos de carga</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'importacion:bodega' %}" class="app-card">
                                <div class="app-icon importacion-bg">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Bodega</h4>
                                    <p>Administre el inventario en bodega</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'importacion:lista_pedidos' %}" class="app-card">
                                <div class="app-icon importacion-bg">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Pedidos</h4>
                                    <p>Gestione los pedidos de importación</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Comercial Category -->
                    <div class="category-section">
                        <div class="category-header comercial-category">
                            <div class="category-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <h3>Gestión Comercial</h3>
                        </div>

                        <div class="app-grid">
                            <a href="{% url 'comercial:clientes' %}" class="app-card">
                                <div class="app-icon comercial-bg">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Clientes</h4>
                                    <p>Administre la base de clientes</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'comercial:lista_ventas' %}" class="app-card">
                                <div class="app-icon comercial-bg">
                                    <i class="fas fa-list"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Lista de Ventas</h4>
                                    <p>Consulte el historial de ventas</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'importacion:transferencias' %}" class="app-card">
                                <div class="app-icon comercial-bg">
                                    <i class="fas fa-cash-register"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Tranferencias / Pagos</h4>
                                    <p>Gestione pagos y gastos generales</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'comercial:dashboard_utilidades' %}" class="app-card">
                                <div class="app-icon comercial-bg">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Análisis de Utilidades</h4>
                                    <p>Visualice reportes de utilidad</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Administración Category -->
                    <div class="category-section">
                        <div class="category-header admin-category">
                            <div class="category-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <h3>Administración del Sistema</h3>
                        </div>

                        <div class="app-grid">
                            <a href="/admin/" class="app-card">
                                <div class="app-icon admin-bg">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Panel de Admin</h4>
                                    <p>Acceda al panel de administración del sistema</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'autenticacion:logout' %}" class="app-card">
                                <div class="app-icon admin-bg">
                                    <i class="fas fa-sign-out-alt"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Cerrar Sesión</h4>
                                    <p>Salir del sistema de manera segura</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <footer class="dashboard-footer">
                    <p>L&M Exotic Fruits - v1.2.0 &copy; 2025 Todos los derechos reservados</p>
                </footer>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function loadClientSummary() {
            const clientSelect = document.getElementById('clientSelect');
            const clientId = clientSelect.value;
            const loadingSpinner = document.getElementById('loadingSpinner');
            const clientSummaryContent = document.getElementById('clientSummaryContent');
            const noClientSelected = document.getElementById('noClientSelected');
            const viewFullStatusBtn = document.getElementById('viewFullStatusBtn');
            
            if (!clientId) {
                clientSummaryContent.style.display = 'none';
                noClientSelected.style.display = 'block';
                viewFullStatusBtn.style.display = 'none';
                return;
            }
            
            // Show loading spinner
            loadingSpinner.style.display = 'block';
            clientSummaryContent.style.display = 'none';
            noClientSelected.style.display = 'none';
            
            // Fetch client summary data
            fetch(`{% url 'comercial:api_cliente_resumen' 0 %}`.replace('0', clientId))
                .then(response => response.json())
                .then(data => {
                    loadingSpinner.style.display = 'none';
                    
                    if (data.success) {
                        // Update client info
                        document.getElementById('selectedClientName').textContent = data.cliente.nombre;
                        document.getElementById('clientPaymentTerms').textContent = `${data.cliente.dias_pago} días`;
                        
                        // Format and update summary data using Euro formatting
                        document.getElementById('totalFacturado').textContent = formatEuro(data.resumen.total_facturado);
                        document.getElementById('totalCajas').textContent = data.resumen.total_cajas_vendidas.toLocaleString();
                        document.getElementById('totalReclamaciones').textContent = formatEuro(data.resumen.total_reclamaciones);
                        document.getElementById('totalPagado').textContent = formatEuro(data.resumen.total_pagado_transferencias);
                        
                        // Update balance with color coding
                        const balanceElement = document.getElementById('saldoActual');
                        const balanceCard = document.getElementById('balanceCard');
                        const saldo = data.resumen.saldo_real;
                        balanceElement.textContent = formatEuro(saldo);
                        
                        // Update balance card style based on saldo
                        balanceCard.className = 'summary-card ';
                        if (saldo > 0) {
                            balanceCard.className += 'summary-card-debt';
                        } else if (saldo < 0) {
                            balanceCard.className += 'summary-card-credit';
                        } else {
                            balanceCard.className += 'summary-card-neutral';
                        }
                        
                        // Update statistics
                        const stats = data.estadisticas_facturas;
                        document.getElementById('totalPendientes').textContent = stats.total_pendientes;
                        document.getElementById('facturasVencidas').textContent = stats.vencidas;
                        document.getElementById('facturasProximas').textContent = stats.proximas;
                        document.getElementById('facturasNormales').textContent = stats.normales;
                        document.getElementById('facturasConAbono').textContent = stats.con_abono;
                        
                        // Update pending invoices
                        updatePendingInvoices(data.facturas_pendientes);
                        
                        // Update the full status button
                        viewFullStatusBtn.href = `{% url 'comercial:estado_cuenta_cliente' 0 %}`.replace('0', clientId);
                        viewFullStatusBtn.style.display = 'inline-block';
                        
                        // Show the summary content
                        clientSummaryContent.style.display = 'block';
                    } else {
                        alert('Error al cargar los datos del cliente');
                        noClientSelected.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingSpinner.style.display = 'none';
                    noClientSelected.style.display = 'block';
                    alert('Error al cargar los datos del cliente');
                });
        }
        
        function formatEuro(value) {
            // Custom Euro formatting similar to Django filter
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }
        
        function updatePendingInvoices(facturas) {
            const container = document.getElementById('pendingInvoicesContainer');
            const noPendingInvoices = document.getElementById('noPendingInvoices');
            
            if (!facturas || facturas.length === 0) {
                container.innerHTML = '';
                noPendingInvoices.style.display = 'block';
                return;
            }
            
            noPendingInvoices.style.display = 'none';
            
            let html = '';
            facturas.forEach(factura => {
                const statusClass = getInvoiceStatusClass(factura.estado);
                const statusIcon = getInvoiceStatusIcon(factura.estado);
                const statusText = getInvoiceStatusText(factura.estado, factura.dias_hasta_vencimiento);
                
                html += `
                    <div class="invoice-item ${statusClass}">
                        <div class="invoice-main-info">
                            <div class="invoice-header">
                                <div class="invoice-number">
                                    <strong>Factura: ${factura.numero_factura || 'N/A'}</strong>
                                    ${factura.tiene_abono ? '<span class="rectificative-badge"><i class="fas fa-file-medical"></i> Con Rectificativa</span>' : ''}
                                </div>
                                <div class="invoice-dates">
                                    <span class="invoice-date"><i class="fas fa-calendar"></i> Fecha: ${factura.fecha_entrega}</span>
                                    <span class="invoice-due-date"><i class="fas fa-calendar-times"></i> Vence: ${factura.fecha_vencimiento}</span>
                                </div>
                            </div>
                            <div class="invoice-amounts">
                                <div class="amount-row">
                                    <span class="amount-label">Factura:</span>
                                    <span class="amount-value">${formatEuro(factura.valor_total)}</span>
                                </div>
                                ${factura.tiene_abono ? `
                                <div class="amount-row rectificative-amount">
                                    <span class="amount-label">Rectificativa:</span>
                                    <span class="amount-value">-${formatEuro(factura.valor_abono)}</span>
                                </div>
                                <div class="amount-row net-amount">
                                    <span class="amount-label"><strong>Neto a pagar:</strong></span>
                                    <span class="amount-value"><strong>${formatEuro(factura.valor_neto)}</strong></span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="invoice-status-section">
                            <div class="status-badge ${statusClass}">
                                <i class="${statusIcon}"></i>
                                <span>${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function getInvoiceStatusClass(estado) {
            switch (estado) {
                case 'vencida': return 'status-overdue';
                case 'proxima': return 'status-due-soon';
                case 'normal': return 'status-normal';
                default: return 'status-unknown';
            }
        }
        
        function getInvoiceStatusIcon(estado) {
            switch (estado) {
                case 'vencida': return 'fas fa-exclamation-triangle';
                case 'proxima': return 'fas fa-clock';
                case 'normal': return 'fas fa-calendar-check';
                default: return 'fas fa-question-circle';
            }
        }
        
        function getInvoiceStatusText(estado, dias) {
            switch (estado) {
                case 'vencida': return `Vencida (${Math.abs(dias)} días)`;
                case 'proxima': return `Vence en ${dias} días`;
                case 'normal': return `${dias} días`;
                default: return 'Estado desconocido';
            }
        }
        
        // Reset modal when closed
        document.getElementById('clientStatusModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('clientSelect').value = '';
            document.getElementById('clientSummaryContent').style.display = 'none';
            document.getElementById('noClientSelected').style.display = 'block';
            document.getElementById('viewFullStatusBtn').style.display = 'none';
        });
    </script>
</body>
</html>
