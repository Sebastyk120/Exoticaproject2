{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exotica Admin Panel</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/home.css' %}" rel="stylesheet">
    <link rel="icon" href="{% static 'img/favicon_dos.ico' %}" type="image/x-icon">
</head>

<body>
    {% csrf_token %}
    <div class="app-container">
        <!-- Main Content Area -->
        <div class="main-content">
            <div class="top-bar">
                <div class="brand">
                    <img src="{% static 'img/favicon_dos.ico' %}" alt="Exotica Logo" class="top-logo"
                        onerror="this.src='https://via.placeholder.com/150x50?text=Exotica'">
                    <h1 class="brand-name">L&M Exotic Fruits</h1>
                </div>

                <div class="breadcrumb-wrapper d-none d-md-block">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
                        </ol>
                    </nav>
                </div>

                <div class="top-actions">
                    <div class="dropdown me-3">
                        <button class="notification-btn" type="button" id="notificationsDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span class="badge">3</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown">
                            <li>
                                <h6 class="dropdown-header">Notificaciones</h6>
                            </li>
                            <li><a class="dropdown-item" href="#">Nueva venta registrada</a></li>
                            <li><a class="dropdown-item" href="#">Llegada de importación</a></li>
                            <li><a class="dropdown-item" href="#">Actualización de precios</a></li>
                        </ul>
                    </div>

                    <div class="dropdown">
                        <button class="user-menu-btn" type="button" id="userDropdown" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <div class="avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="user-info d-none d-md-block">
                                <span class="user-name">{{ user.get_full_name|default:user.username }}</span>
                                <span
                                    class="user-role {% if user.is_superuser %}role-admin{% else %}role-staff{% endif %}">
                                    {% if user.is_superuser %}Administrator{% else %}Staff{% endif %}
                                </span>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog"></i> Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Configuración</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{% url 'autenticacion:logout' %}"><i
                                        class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="content-wrapper">
                <div class="dashboard-header">
                    <h2>Panel Principal</h2>
                    <p class="text-muted">Bienvenido, {{ user.get_full_name|default:user.username }}. Aquí puedes
                        acceder a todas las funcionalidades del sistema.</p>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="row">
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'comercial:clientes' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-comercial);">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Clientes</h3>
                                        <p class="stat-number">{{ client_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'productos:presentaciones_view' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-productos);">
                                        <i class="fas fa-apple-alt"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Productos</h3>
                                        <p class="stat-number">{{ product_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'importacion:lista_pedidos' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-importacion);">
                                        <i class="fas fa-ship"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Importaciones</h3>
                                        <p class="stat-number">{{ import_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'comercial:lista_ventas' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-comercial-alt);">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Ventas</h3>
                                        <p class="stat-number">{{ sales_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'productos:lista_cotizaciones' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-cotizaciones);">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Cotizaciones</h3>
                                        <p class="stat-number">{{ cotizacion_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-2-4 col-sm-6 mb-4">
                            <a href="{% url 'comercial:lista_correos' %}" class="text-decoration-none">
                                <div class="stat-card">
                                    <div class="stat-icon" style="background-color: var(--section-comercial);">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="stat-data">
                                        <h3>Correos</h3>
                                        <p class="stat-number">{{ email_count|default:"0" }}</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Utility Analysis Banner -->
                <div class="utility-banner mb-4">
                    <a href="{% url 'comercial:dashboard_utilidades' %}" class="text-decoration-none">
                        <div class="utility-card">
                            <div class="utility-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="utility-content">
                                <h3>Análisis de Utilidades</h3>
                                <p>Visualice reportes detallados de utilidades y rendimiento comercial</p>
                            </div>
                            <div class="utility-action">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Client Account Status Banner -->
                <div class="utility-banner mb-4">
                    <div class="text-decoration-none" style="cursor: pointer;" data-bs-toggle="modal"
                        data-bs-target="#clientStatusModal">
                        <div class="client-status-card">
                            <div class="client-status-icon">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="client-status-content">
                                <h3>Estado de Cuenta de Clientes</h3>
                                <p>Consulte rápidamente el estado financiero de sus clientes</p>
                            </div>
                            <div class="client-status-action">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Status Modal -->
                <div class="modal fade" id="clientStatusModal" tabindex="-1" aria-labelledby="clientStatusModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <div class="d-flex align-items-center w-100">
                                    <h5 class="modal-title me-3" id="clientStatusModalLabel">
                                        <i class="fas fa-user-tie me-2"></i>Estado de Cuenta
                                    </h5>
                                    <div class="flex-grow-1 me-3">
                                        <select class="form-select form-select-sm" id="clientSelect"
                                            onchange="loadClientSummary()">
                                            <option value="">-- Seleccione un cliente --</option>
                                            {% for cliente in clientes %}
                                            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div id="clientPaymentTermsHeader" class="client-payment-terms-compact me-3"
                                        style="display: none;">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        <span id="clientPaymentTermsHeaderText" class="fw-bold"></span>
                                    </div>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="clientSummaryContent" style="display: none;">

                                    <!-- Compact Summary Row -->
                                    <div class="row g-2 mb-3">
                                        <div class="col-lg-2 col-md-4 col-6">
                                            <div class="summary-card-compact summary-card-primary">
                                                <div class="summary-label">
                                                    <i class="fas fa-file-invoice-dollar me-1"></i>Facturado
                                                </div>
                                                <div id="totalFacturado" class="summary-value">€0.00</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-2 col-md-4 col-6">
                                            <div class="summary-card-compact summary-card-info">
                                                <div class="summary-label">
                                                    <i class="fas fa-boxes me-1"></i>Cajas
                                                </div>
                                                <div id="totalCajas" class="summary-value">0</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-2 col-md-4 col-6">
                                            <div class="summary-card-compact summary-card-warning">
                                                <div class="summary-label">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Abonos
                                                </div>
                                                <div id="totalReclamaciones" class="summary-value">€0.00</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-2 col-md-4 col-6">
                                            <div class="summary-card-compact summary-card-success">
                                                <div class="summary-label">
                                                    <i class="fas fa-credit-card me-1"></i>Pagado
                                                </div>
                                                <div id="totalPagado" class="summary-value">€0.00</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-2 col-md-4 col-6">
                                            <div class="summary-card-compact summary-card-balance" id="balanceCard">
                                                <div class="summary-label">
                                                    <i class="fas fa-balance-scale me-1"></i>Saldo
                                                </div>
                                                <div id="saldoActual" class="summary-value">€0.00</div>
                                            </div>
                                        </div>
                                        <div class="col-lg-2 col-md-4 col-6">
                                            <div class="summary-card-compact summary-card-pending">
                                                <div class="summary-label">
                                                    <i class="fas fa-clock me-1"></i>Pendientes
                                                </div>
                                                <div id="totalPendientes" class="summary-value">0</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Compact Statistics -->
                                    <div class="row g-2 mb-3">
                                        <div class="col-lg-3 col-6">
                                            <div class="stat-badge stat-overdue">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <span class="stat-badge-label">Vencidas:</span>
                                                <span id="facturasVencidas" class="stat-badge-value">0</span>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-6">
                                            <div class="stat-badge stat-due-soon">
                                                <i class="fas fa-clock me-2"></i>
                                                <span class="stat-badge-label">Próximas (≤7d):</span>
                                                <span id="facturasProximas" class="stat-badge-value">0</span>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-6">
                                            <div class="stat-badge stat-normal">
                                                <i class="fas fa-calendar-check me-2"></i>
                                                <span class="stat-badge-label">Normales:</span>
                                                <span id="facturasNormales" class="stat-badge-value">0</span>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-6">
                                            <div class="stat-badge stat-with-rectificative">
                                                <i class="fas fa-file-medical me-2"></i>
                                                <span class="stat-badge-label">Con Abonos:</span>
                                                <span id="facturasConAbono" class="stat-badge-value">0</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Pending Invoices Section -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title mb-3">
                                                        <i class="fas fa-list-alt me-2"></i>Facturas Próximas a Vencer /
                                                        Pendientes de Pago
                                                    </h6>
                                                    <div class="table-container">
                                                        <div class="table-responsive">
                                                            <table
                                                                class="table table-hover table-striped compact-table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>F. Emisión</th>
                                                                        <th>Nº Factura</th>
                                                                        <th>Total Factura</th>
                                                                        <th>Abonos</th>
                                                                        <th>Pendiente</th>
                                                                        <th>F. Vencimiento</th>
                                                                        <th>Estado</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="pendingInvoicesTableBody">
                                                                    <!-- Invoices will be populated here -->
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <div id="noPendingInvoices" class="text-center text-muted py-4"
                                                        style="display: none;">
                                                        <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                                                        <h5 class="text-success">¡Excelente!</h5>
                                                        <p class="mb-0">No hay facturas pendientes de pago</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="loadingSpinner" class="text-center" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </div>
                                </div>

                                <div id="noClientSelected" class="text-center text-muted py-5">
                                    <i class="fas fa-user-plus fa-3x mb-3"></i>
                                    <p>Seleccione un cliente para ver su estado de cuenta</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" id="sendEmailBtn" class="btn btn-success" style="display: none;" onclick="showEmailForm()">
                                    <i class="fas fa-envelope me-1"></i>Enviar por Email
                                </button>
                                <a id="viewFullStatusBtn" href="#" class="btn btn-primary" style="display: none;">
                                    <i class="fas fa-external-link-alt me-1"></i>Ver Estado Completo
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Form Modal -->
                <div class="modal fade" id="emailFormModal" tabindex="-1" aria-labelledby="emailFormModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="emailFormModalLabel">
                                    <i class="fas fa-envelope me-2"></i>Enviar Estado de Cuenta por Email
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="emailForm" onsubmit="sendAccountStatusEmail(event)">
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="clienteEmailInfo" class="form-label">Cliente</label>
                                                <input type="text" class="form-control" id="clienteEmailInfo" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="emailSubject" class="form-label">Asunto</label>
                                                <input type="text" class="form-control" id="emailSubject" name="email_subject" 
                                                       value="Estado de Cuenta - L&M Exotic Fruit" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="email-form-section">
                                        <label class="form-label">Correos Electrónicos</label>
                                        <div id="emailSelectionContainer">
                                            <!-- Email options will be populated here -->
                                        </div>
                                        <div class="mt-2">
                                            <input type="email" class="form-control email-additional-input" id="additionalEmail" 
                                                   placeholder="Agregar correo adicional (opcional)">
                                            <button type="button" class="btn btn-sm btn-outline-primary mt-1" onclick="addAdditionalEmail()">
                                                <i class="fas fa-plus me-1"></i>Agregar
                                            </button>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="emailMessage" class="form-label">Mensaje Adicional (opcional)</label>
                                        <textarea class="form-control" id="emailMessage" name="email_message" 
                                                  rows="4" placeholder="Puede agregar un mensaje personalizado aquí..."></textarea>
                                    </div>

                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Nota:</strong> El email incluirá automáticamente el resumen del estado de cuenta con las facturas pendientes de pago.
                                    </div>
                                    
                                    <!-- Loading message -->
                                    <div id="emailLoading" class="email-loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Enviando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Enviando email, por favor espere...</p>
                                    </div>
                                    
                                    <!-- Success message -->
                                    <div id="emailSuccess" class="email-success" style="display: none;">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>¡Éxito!</strong> El email ha sido enviado correctamente.
                                    </div>
                                    
                                    <!-- Error message -->
                                    <div id="emailError" class="email-error" style="display: none;">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        <strong>Error:</strong> <span id="emailErrorText"></span>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-email-cancel" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-email-send">
                                        <i class="fas fa-paper-plane me-1"></i>Enviar Email
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- App Categories -->
                <div class="app-categories">
                    <div class="row">
                        <!-- Productos Category -->
                        <div class="col-12">
                            <div class="category-section">
                            <div class="category-header productos-category">
                                <div class="category-icon">
                                    <i class="fas fa-apple-alt"></i>
                                </div>
                                <h3>Gestión de Productos</h3>
                            </div>

                            <div class="app-grid">
                                <a href="{% url 'productos:frutas_view' %}" class="app-card">
                                    <div class="app-icon productos-bg">
                                        <i class="fas fa-lemon"></i>
                                    </div>
                                    <div class="app-info">
                                        <h4>Frutas</h4>
                                        <p>Administre el catálogo de frutas</p>
                                    </div>
                                    <div class="app-action">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>

                            <a href="{% url 'productos:presentaciones_view' %}" class="app-card">
                                <div class="app-icon productos-bg">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Presentaciones</h4>
                                    <p>Gestione los formatos de presentación</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'productos:lista_precios_importacion' %}" class="app-card">
                                <div class="app-icon productos-bg">
                                    <i class="fas fa-ship"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Precios de Importación</h4>
                                    <p>Consulte y actualice los precios de importación</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'productos:lista_precios_ventas' %}" class="app-card">
                                <div class="app-icon productos-bg">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Precios de Venta</h4>
                                    <p>Administre los precios de venta</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Importación Category -->
                    <div class="col-12">
                        <div class="category-section">
                            <div class="category-header importacion-category">
                                <div class="category-icon">
                                    <i class="fas fa-ship"></i>
                                </div>
                                <h3>Gestión de Importaciones</h3>
                            </div>

                            <div class="app-grid">
                                <a href="{% url 'importacion:aduana_pdf' %}" class="app-card">
                                    <div class="app-icon importacion-bg">
                                        <i class="fas fa-passport"></i>
                                    </div>
                                    <div class="app-info">
                                        <h4>Aduana PDF</h4>
                                        <p>Procese documentos de aduana</p>
                                    </div>
                                    <div class="app-action">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>

                            <a href="{% url 'importacion:carga_pdf' %}" class="app-card">
                                <div class="app-icon importacion-bg">
                                    <i class="fas fa-truck-loading"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Carga PDF</h4>
                                    <p>Procese documentos de carga</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'importacion:bodega' %}" class="app-card">
                                <div class="app-icon importacion-bg">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Bodega</h4>
                                    <p>Administre el inventario en bodega</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'importacion:lista_pedidos' %}" class="app-card">
                                <div class="app-icon importacion-bg">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Pedidos</h4>
                                    <p>Gestione los pedidos de importación</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Comercial Category -->
                    <div class="col-12">
                        <div class="category-section">
                            <div class="category-header comercial-category">
                                <div class="category-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <h3>Gestión Comercial</h3>
                            </div>

                            <div class="app-grid">
                                <a href="{% url 'comercial:clientes' %}" class="app-card">
                                    <div class="app-icon comercial-bg">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="app-info">
                                        <h4>Clientes</h4>
                                        <p>Administre la base de clientes</p>
                                    </div>
                                    <div class="app-action">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>

                            <a href="{% url 'comercial:lista_ventas' %}" class="app-card">
                                <div class="app-icon comercial-bg">
                                    <i class="fas fa-list"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Lista de Ventas</h4>
                                    <p>Consulte el historial de ventas</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'importacion:transferencias' %}" class="app-card">
                                <div class="app-icon comercial-bg">
                                    <i class="fas fa-cash-register"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Tranferencias / Pagos</h4>
                                    <p>Gestione pagos y gastos generales</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>

                            <a href="{% url 'comercial:dashboard_utilidades' %}" class="app-card">
                                <div class="app-icon comercial-bg">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Análisis de Utilidades</h4>
                                    <p>Visualice reportes de utilidad</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Administración Category -->
                    <div class="col-12">
                        <div class="category-section">
                            <div class="category-header admin-category">
                                <div class="category-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <h3>Administración del Sistema</h3>
                            </div>

                            <div class="app-grid">
                                <a href="/admin/" class="app-card">
                                    <div class="app-icon admin-bg">
                                        <i class="fas fa-tools"></i>
                                    </div>
                                    <div class="app-info">
                                        <h4>Panel de Admin</h4>
                                        <p>Acceda al panel de administración del sistema</p>
                                    </div>
                                    <div class="app-action">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>

                            <a href="{% url 'autenticacion:logout' %}" class="app-card">
                                <div class="app-icon admin-bg">
                                    <i class="fas fa-sign-out-alt"></i>
                                </div>
                                <div class="app-info">
                                    <h4>Cerrar Sesión</h4>
                                    <p>Salir del sistema de manera segura</p>
                                </div>
                                <div class="app-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                    </div>
                </div>

                <footer class="dashboard-footer">
                    <p>L&M Exotic Fruits - v1.2.0 &copy; 2025 Todos los derechos reservados</p>
                </footer>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function loadClientSummary() {
            const clientSelect = document.getElementById('clientSelect');
            const clientId = clientSelect.value;
            const loadingSpinner = document.getElementById('loadingSpinner');
            const clientSummaryContent = document.getElementById('clientSummaryContent');
            const noClientSelected = document.getElementById('noClientSelected');
            const viewFullStatusBtn = document.getElementById('viewFullStatusBtn');

            if (!clientId) {
                clientSummaryContent.style.display = 'none';
                noClientSelected.style.display = 'block';
                viewFullStatusBtn.style.display = 'none';
                document.getElementById('clientPaymentTermsHeader').style.display = 'none';
                return;
            }

            // Show loading spinner
            loadingSpinner.style.display = 'block';
            clientSummaryContent.style.display = 'none';
            noClientSelected.style.display = 'none';

            // Fetch client summary data
            fetch(`{% url 'comercial:api_cliente_resumen' 0 %}`.replace('0', clientId))
                .then(response => response.json())
                .then(data => {
                    loadingSpinner.style.display = 'none';

                    if (data.success) {
                        // Update payment terms in header
                        const paymentTermsHeader = document.getElementById('clientPaymentTermsHeader');
                        const paymentTermsHeaderText = document.getElementById('clientPaymentTermsHeaderText');
                        paymentTermsHeaderText.textContent = `${data.cliente.dias_pago} días`;
                        paymentTermsHeader.style.display = 'block';

                        // Format and update summary data using Euro formatting
                        document.getElementById('totalFacturado').textContent = formatEuro(data.resumen.total_facturado);
                        document.getElementById('totalCajas').textContent = data.resumen.total_cajas_vendidas.toLocaleString();
                        document.getElementById('totalReclamaciones').textContent = formatEuro(data.resumen.total_reclamaciones);
                        document.getElementById('totalPagado').textContent = formatEuro(data.resumen.total_pagado_transferencias);

                        // Update balance with color coding
                        const balanceElement = document.getElementById('saldoActual');
                        const balanceCard = document.getElementById('balanceCard');
                        const saldo = data.resumen.saldo_real;
                        balanceElement.textContent = formatEuro(saldo);

                        // Update balance card style based on saldo
                        balanceCard.className = 'summary-card-compact ';
                        if (saldo > 0) {
                            balanceCard.className += 'summary-card-debt';
                        } else if (saldo < 0) {
                            balanceCard.className += 'summary-card-credit';
                        } else {
                            balanceCard.className += 'summary-card-neutral';
                        }

                        // Update statistics
                        const stats = data.estadisticas_facturas;
                        document.getElementById('totalPendientes').textContent = stats.total_pendientes;
                        document.getElementById('facturasVencidas').textContent = stats.vencidas;
                        document.getElementById('facturasProximas').textContent = stats.proximas;
                        document.getElementById('facturasNormales').textContent = stats.normales;
                        document.getElementById('facturasConAbono').textContent = stats.con_abono;

                        // Update pending invoices
                        updatePendingInvoices(data.facturas_pendientes);

                        // Update the full status button
                        viewFullStatusBtn.href = `{% url 'comercial:estado_cuenta_cliente' 0 %}`.replace('0', clientId);
                        viewFullStatusBtn.style.display = 'inline-block';

                        // Show the summary content
                        clientSummaryContent.style.display = 'block';
                    } else {
                        alert('Error al cargar los datos del cliente');
                        noClientSelected.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingSpinner.style.display = 'none';
                    noClientSelected.style.display = 'block';
                    alert('Error al cargar los datos del cliente');
                });
        }

        function formatEuro(value) {
            // Custom Euro formatting similar to Django filter
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function updatePendingInvoices(facturas) {
            const tableBody = document.getElementById('pendingInvoicesTableBody');
            const noPendingInvoices = document.getElementById('noPendingInvoices');
            const tableContainer = tableBody.closest('.table-container');

            if (!facturas || facturas.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay facturas pendientes de pago</td></tr>';
                tableContainer.style.display = 'none';
                noPendingInvoices.style.display = 'block';
                return;
            }

            tableContainer.style.display = 'block';
            noPendingInvoices.style.display = 'none';

            let html = '';
            facturas.forEach(factura => {
                const rowClass = getTableRowClass(factura.estado);
                const statusBadge = getStatusBadge(factura.estado, factura.dias_hasta_vencimiento);
                const abonoDisplay = factura.tiene_abono && factura.valor_abono > 0
                    ? `<span class="text-danger fw-bold">${formatEuro(factura.valor_abono)}</span>`
                    : '<span class="text-muted">-</span>';

                html += `
                    <tr class="${rowClass}">
                        <td class="text-nowrap">${factura.fecha_entrega}</td>
                        <td class="fw-bold">${factura.numero_factura || 'N/A'}</td>
                        <td class="text-nowrap">${formatEuro(factura.valor_total)}</td>
                        <td class="text-nowrap">${abonoDisplay}</td>
                        <td class="text-nowrap fw-bold">${formatEuro(factura.valor_neto)}</td>
                        <td class="text-nowrap">${factura.fecha_vencimiento || '-'}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        function getTableRowClass(estado) {
            switch (estado) {
                case 'vencida': return 'table-danger';
                case 'proxima': return 'table-warning';
                case 'normal': return 'table-success';
                default: return 'table-secondary';
            }
        }

        function getStatusBadge(estado, dias) {
            let badgeClass = '';
            let badgeText = '';

            if (dias !== null && dias !== undefined) {
                if (dias < 0) {
                    badgeClass = 'bg-danger';
                    badgeText = `Vencida ${Math.abs(dias)} días`;
                } else if (dias === 0) {
                    badgeClass = 'bg-danger';
                    badgeText = 'Hoy';
                } else if (dias <= 7) {
                    badgeClass = 'bg-warning';
                    badgeText = `A ${dias} días de vencer`;
                } else {
                    badgeClass = 'bg-success';
                    badgeText = `A ${dias} días de vencer`;
                }
            } else {
                badgeClass = 'bg-secondary';
                badgeText = '-';
            }

            return `<span class="badge ${badgeClass}">${badgeText}</span>`;
        }


        // Reset modal when closed
        document.getElementById('clientStatusModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('clientSelect').value = '';
            document.getElementById('clientSummaryContent').style.display = 'none';
            document.getElementById('noClientSelected').style.display = 'block';
            document.getElementById('viewFullStatusBtn').style.display = 'none';
            document.getElementById('sendEmailBtn').style.display = 'none';
        });

        // Email functionality variables
        let currentClientData = null;
        let selectedEmails = [];

        // Show email form modal
        function showEmailForm() {
            const clientSelect = document.getElementById('clientSelect');
            const clienteId = clientSelect.value;
            const clienteText = clientSelect.options[clientSelect.selectedIndex].text;
            
            if (!clienteId) {
                alert('Por favor seleccione un cliente primero');
                return;
            }

            // Set cliente info
            document.getElementById('clienteEmailInfo').value = clienteText;
            
            // Reset email form
            document.getElementById('emailForm').reset();
            selectedEmails = [];
            
            // Load client emails
            loadClientEmails(clienteId);
            
            // Show email modal
            const emailModal = new bootstrap.Modal(document.getElementById('emailFormModal'));
            emailModal.show();
        }

        // Load client emails for selection
        function loadClientEmails(clienteId) {
            const container = document.getElementById('emailSelectionContainer');
            container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div></div>';
            
            fetch(`/comercial/get-client-emails/${clienteId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                            let html = '';
                            data.emails.forEach(email => {
                                html += `
                                    <div class="email-list-item">
                                        <input class="form-check-input email-checkbox" type="checkbox" 
                                               id="email_${email}" value="${email}" 
                                               onchange="toggleEmailSelection('${email}')" checked>
                                        <label class="form-check-label" for="email_${email}">
                                            ${email}
                                        </label>
                                    </div>
                            `;
                                selectedEmails.push(email);
                            });
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = '<div class="alert alert-warning">No se pudieron cargar los correos del cliente</div>';
                        }
                })
                .catch(error => {
                    console.error('Error loading client emails:', error);
                    container.innerHTML = '<div class="alert alert-danger">Error al cargar correos</div>';
                });
        }

        // Toggle email selection
        function toggleEmailSelection(email) {
            const index = selectedEmails.indexOf(email);
            if (index > -1) {
                selectedEmails.splice(index, 1);
            } else {
                selectedEmails.push(email);
            }
        }

        // Add additional email
        function addAdditionalEmail() {
            const input = document.getElementById('additionalEmail');
            const email = input.value.trim();
            
            if (email && !selectedEmails.includes(email)) {
                selectedEmails.push(email);
                
                // Add to UI
                const container = document.getElementById('emailSelectionContainer');
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" 
                           id="email_${email}" value="${email}" 
                           onchange="toggleEmailSelection('${email}')" checked>
                    <label class="form-check-label" for="email_${email}">
                        ${email} (adicional)
                    </label>
                `;
                container.appendChild(div);
                
                // Clear input
                input.value = '';
            }
        }

        // Send account status email
        function sendAccountStatusEmail(event) {
            event.preventDefault();
            
            if (selectedEmails.length === 0) {
                alert('Por favor seleccione al menos un correo electrónico');
                return;
            }
            
            // Show loading state
            document.getElementById('emailLoading').style.display = 'block';
            document.getElementById('emailSuccess').style.display = 'none';
            document.getElementById('emailError').style.display = 'none';
            
            // Disable submit button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
            submitBtn.disabled = true;
            
            const clienteId = document.getElementById('clientSelect').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            const formData = new FormData();
            formData.append('cliente_id', clienteId);
            formData.append('selected_emails', JSON.stringify(selectedEmails));
            formData.append('email_subject', subject);
            formData.append('email_message', message);
            
            fetch("{% url 'autenticacion:enviar_estado_cuenta' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('emailLoading').style.display = 'none';
                
                if (data.success) {
                    // Show success message
                    document.getElementById('emailSuccess').style.display = 'block';
                    
                    // Wait 2 seconds then close modals
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('emailFormModal')).hide();
                        bootstrap.Modal.getInstance(document.getElementById('clientStatusModal')).hide();
                        
                        // Reset form
                        document.getElementById('emailForm').reset();
                        selectedEmails = [];
                        document.getElementById('emailSelectionContainer').innerHTML = '';
                    }, 2000);
                } else {
                    // Show error message
                    document.getElementById('emailError').style.display = 'block';
                    document.getElementById('emailErrorText').textContent = data.error;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('emailLoading').style.display = 'none';
                document.getElementById('emailError').style.display = 'block';
                document.getElementById('emailErrorText').textContent = 'Error al enviar el email. Por favor intente nuevamente.';
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        // Update the loadClientSummary function to show/hide email button
        const originalLoadClientSummary = loadClientSummary;
        loadClientSummary = function() {
            originalLoadClientSummary();
            
            // Show/hide email button based on client selection
            const clientId = document.getElementById('clientSelect').value;
            const sendEmailBtn = document.getElementById('sendEmailBtn');
            
            if (clientId) {
                sendEmailBtn.style.display = 'inline-block';
            } else {
                sendEmailBtn.style.display = 'none';
            }
        };
    </script>
</body>

</html>
