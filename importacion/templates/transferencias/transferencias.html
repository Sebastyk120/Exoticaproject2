{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard de Transferencias{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/transferencias/transferencias.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid content-wrapper">
    <!-- Header Section -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="page-title">
                <i class="bi bi-cash-coin"></i>
                Dashboard de Transferencias
            </h1>
            <p class="text-muted mt-2">Gestiona y supervisa todas las transferencias financieras del sistema</p>
        </div>
    </div>

    <!-- Enhanced Balance Cards -->
    <div class="row balance-cards">
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-4">
            <div class="balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceExportador">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="balance-info">
                            <h6 class="card-subtitle">Balance Exportadores</h6>
                            <h3 class="card-title">{{ total_balance_exportadores|format_currency }}</h3>
                            <p class="text-muted">Saldo disponible total</p>
                            <div class="balance-badge badge badge-primary">
                                <i class="bi bi-arrow-up-circle"></i> Activo
                            </div>
                        </div>
                        <div class="icon-box bg-primary">
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-4">
            <div class="balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceAduana">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="balance-info">
                            <h6 class="card-subtitle">Balance Aduanas</h6>
                            <h3 class="card-title">{{ total_balance_aduanas|format_currency_eur }}</h3>
                            <p class="text-muted">Saldo disponible total</p>
                            <div class="balance-badge badge badge-warning">
                                <i class="bi bi-arrow-up-circle"></i> Activo
                            </div>
                        </div>
                        <div class="icon-box bg-warning">
                            <i class="bi bi-building"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-4">
            <div class="balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceCarga">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="balance-info">
                            <h6 class="card-subtitle">Balance Agencias de Carga</h6>
                            <h3 class="card-title">{{ total_balance_cargas|format_currency }}</h3>
                            <p class="text-muted">Saldo disponible total</p>
                            <div class="balance-badge badge badge-info">
                                <i class="bi bi-arrow-up-circle"></i> Activo
                            </div>
                        </div>
                        <div class="icon-box bg-info">
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-4">
            <div class="balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceCliente">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="balance-info">
                            <h6 class="card-subtitle">Balance Clientes</h6>
                            <h3 class="card-title">{{ total_balance_clientes|format_currency_eur }}</h3>
                            <p class="text-muted">Saldo disponible total</p>
                            <div class="balance-badge badge badge-success">
                                <i class="bi bi-arrow-up-circle"></i> Activo
                            </div>
                        </div>
                        <div class="icon-box bg-success">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-card">
                <div class="card-body">
                    <h4 class="card-title mb-4">
                        <i class="bi bi-lightning"></i>
                        Acciones Rápidas
                    </h4>
                    <div class="row navigation-buttons">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <a href="{% url 'importacion:transferencias_exportador_list' %}"
                                class="btn btn-primary w-100 btn-with-icon">
                                <i class="bi bi-truck"></i>
                                <div class="btn-text">
                                    <strong>Pago a</strong>
                                    <small>Exportadores</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <a href="{% url 'importacion:transferencias_aduana_list' %}"
                                class="btn btn-warning w-100 btn-with-icon">
                                <i class="bi bi-building"></i>
                                <div class="btn-text">
                                    <strong>Pago a</strong>
                                    <small>Aduanas</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <a href="{% url 'importacion:transferencias_carga_list' %}"
                                class="btn btn-info w-100 btn-with-icon">
                                <i class="bi bi-box-seam"></i>
                                <div class="btn-text">
                                    <strong>Pago a</strong>
                                    <small>Agencias de Carga</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <a href="{% url 'importacion:transferencias_cliente_list' %}"
                                class="btn btn-success w-100 btn-with-icon">
                                <i class="bi bi-people"></i>
                                <div class="btn-text">
                                    <strong>Pago de</strong>
                                    <small>Clientes</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Summary -->
    <div class="row">
        <div class="col-12">
            <div class="content-card">
                <div class="card-body">
                    <h4 class="card-title mb-4">
                        <i class="bi bi-graph-up"></i>
                        Resumen Estadístico
                    </h4>
                    <div class="row text-center">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number">{{
                                    total_balance_exportadores|add:total_balance_aduanas|add:total_balance_cargas|add:total_balance_clientes|format_currency
                                    }}</div>
                                <div class="stat-label">Total General</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number">4</div>
                                <div class="stat-label">Tipos de Transferencias</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number">{{
                                    balances_exportador|length|add:balances_aduana|length|add:balances_carga|length|add:balances_cliente|length
                                    }}</div>
                                <div class="stat-label">Total Entidades</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stat-item">
                                <div class="stat-number">100%</div>
                                <div class="stat-label">Sistema Activo</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS for balances -->
<!-- Exportador Balance Modal -->
<div class="modal fade" id="modalBalanceExportador" tabindex="-1" aria-labelledby="modalBalanceExportadorLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceExportadorLabel">
                    <i class="bi bi-truck me-2"></i>Balance de Exportadores
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Exportador</th>
                                <th class="text-end">Saldo Disponible USD</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_exportador %}
                            <tr>
                                <td>{{ balance.exportador.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|format_currency }}</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_exportadores|format_currency }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Aduana Balance Modal -->
<div class="modal fade" id="modalBalanceAduana" tabindex="-1" aria-labelledby="modalBalanceAduanaLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceAduanaLabel">
                    <i class="bi bi-building me-2"></i>Balance de Agencias de Aduana
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Agencia Aduana</th>
                                <th class="text-end">Saldo Disponible USD</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_aduana %}
                            <tr>
                                <td>{{ balance.agencia_aduana.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|format_currency_eur }}</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_aduanas|format_currency_eur }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Carga Balance Modal -->
<div class="modal fade" id="modalBalanceCarga" tabindex="-1" aria-labelledby="modalBalanceCargaLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceCargaLabel">
                    <i class="bi bi-box-seam me-2"></i>Balance de Agencias de Carga
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Agencia Carga</th>
                                <th class="text-end">Saldo Disponible USD</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_carga %}
                            <tr>
                                <td>{{ balance.agencia_carga.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|format_currency }}</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_cargas|format_currency }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Cliente Balance Modal -->
<div class="modal fade" id="modalBalanceCliente" tabindex="-1" aria-labelledby="modalBalanceClienteLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceClienteLabel">
                    <i class="bi bi-people me-2"></i>Balance de Clientes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th class="text-end">Saldo Disponible EUR</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_cliente %}
                            <tr>
                                <td>{{ balance.cliente.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|floatformat:2 }} €</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_clientes|default:"0.00"|floatformat:2 }} €</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}