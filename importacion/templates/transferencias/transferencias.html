{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Gestión de Transferencias{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/transferencias/transferencias.css' %}">
{% endblock %}

{% block content %}
<!-- Floating Feedback Toast -->
<div class="toast-container position-fixed bottom-0 start-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">Notificación</strong>
            <small id="toastTime">Ahora</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Operación completada con éxito.
        </div>
    </div>
</div>

<div class="container-fluid content-wrapper">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="page-title"><i class="bi bi-cash-coin me-2"></i>Gestión de Transferencias</h1>
        </div>
    </div>

    <!-- Balance Cards -->
    <div class="row mb-4 balance-cards">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceExportador">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-muted">Balance Exportadores</h6>
                            <h3 class="card-title mb-0">{{ total_balance_exportadores|format_currency }}</h3>
                            <p class="text-muted mb-0">Saldo disponible total</p>
                        </div>
                        <div class="icon-box bg-primary">
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceAduana">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-muted">Balance Aduanas</h6>
                            <h3 class="card-title mb-0">{{ total_balance_aduanas|format_currency_eur }}</h3>
                            <p class="text-muted mb-0">Saldo disponible total</p>
                        </div>
                        <div class="icon-box bg-warning">
                            <i class="bi bi-building"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceCarga">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-muted">Balance Agencias de Carga</h6>
                            <h3 class="card-title mb-0">{{ total_balance_cargas|format_currency }}</h3>
                            <p class="text-muted mb-0">Saldo disponible total</p>
                        </div>
                        <div class="icon-box bg-info">
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card balance-card" data-bs-toggle="modal" data-bs-target="#modalBalanceCliente">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-muted">Balance Clientes</h6>
                            <h3 class="card-title mb-0">{{ total_balance_clientes|format_currency_eur }}</h3>
                            <p class="text-muted mb-0">Saldo disponible total</p>
                        </div>
                        <div class="icon-box bg-success">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation with Pills style -->
    <div class="tabs-container">
        <ul class="nav nav-pills mb-4 custom-tabs" id="transferenciasTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'exportador' %}active{% endif %}" id="exportador-tab" data-bs-toggle="tab" data-bs-target="#exportador" type="button" role="tab" aria-controls="exportador" aria-selected="{% if active_tab == 'exportador' %}true{% else %}false{% endif %}">
                    <i class="bi bi-truck"></i> <span class="tab-label">Exportadores</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'aduana' %}active{% endif %}" id="aduana-tab" data-bs-toggle="tab" data-bs-target="#aduana" type="button" role="tab" aria-controls="aduana" aria-selected="{% if active_tab == 'aduana' %}true{% else %}false{% endif %}">
                    <i class="bi bi-building"></i> <span class="tab-label">Aduanas</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'carga' %}active{% endif %}" id="carga-tab" data-bs-toggle="tab" data-bs-target="#carga" type="button" role="tab" aria-controls="carga" aria-selected="{% if active_tab == 'carga' %}true{% else %}false{% endif %}">
                    <i class="bi bi-box-seam"></i> <span class="tab-label">Agencias de Carga</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if active_tab == 'cliente' %}active{% endif %}" id="cliente-tab" data-bs-toggle="tab" data-bs-target="#cliente" type="button" role="tab" aria-controls="cliente" aria-selected="{% if active_tab == 'cliente' %}true{% else %}false{% endif %}">
                    <i class="bi bi-people"></i> <span class="tab-label">Clientes</span>
                </button>
            </li>
        </ul>
    </div>

    <!-- Tab Content with enhanced styling -->
    <div class="tab-content" id="transferenciasTabContent">
        <!-- Exportador Tab -->
        <div class="tab-pane fade {% if active_tab == 'exportador' %}show active{% endif %}" id="exportador" role="tabpanel" aria-labelledby="exportador-tab">
            <div class="card content-card">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                    <h5 class="card-title mb-2 mb-md-0">
                        <i class="bi bi-truck me-2"></i>Transferencias a Exportadores
                    </h5>
                    <div class="actions">
                        <button type="button" class="btn btn-primary btn-with-icon" data-bs-toggle="modal" data-bs-target="#modalCrearExportador">
                            <i class="bi bi-plus-circle"></i> Nueva Transferencia
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-filters d-flex flex-column flex-md-row justify-content-between mb-3">
                        <div class="d-flex flex-wrap gap-2 mb-2 mb-md-0">
                            <div class="input-group search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchExportador" placeholder="Buscar...">
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                <li><a class="dropdown-item" href="#" data-filter="all">Todas</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="month">Último mes</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="week">Última semana</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="table-responsive table-container">
                        <table class="table table-striped table-hover data-table" id="tablaExportador">
                            <thead>
                                <tr>
                                    <th class="text-center">#</th>
                                    <th>Exportador</th>
                                    <th>Referencia</th>
                                    <th>Fecha</th>
                                    <th class="text-end">Valor USD</th>
                                    <th class="text-end">Valor EUR</th>
                                    <th class="text-end">TRM</th>
                                    <th>Concepto</th>
                                    <th class="text-end">Saldo</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transferencia in transferencias_exportador %}
                                <tr>
                                    <td class="text-center id-column">{{ transferencia.id }}</td>
                                    <td>{{ transferencia.exportador.nombre }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ transferencia.referencia }}</span>
                                    </td>
                                    <td>{{ transferencia.fecha_transferencia|date:"d/m/Y" }}</td>
                                    <td class="text-end">
                                        <span class="currency-value">{{ transferencia.valor_transferencia|format_currency }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="currency-value">{{ transferencia.valor_transferencia_eur|format_currency_eur }}</span>
                                    </td>
                                    <td class="text-end">{{ transferencia.trm|floatformat:2 }}</td>
                                    <td>
                                        <span class="truncate-text" data-bs-toggle="tooltip" title="{{ transferencia.concepto }}">
                                            {{ transferencia.concepto|truncatechars:20 }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <span class="currency-value fw-bold">{{ transferencia.saldo_transferencia|format_currency }}</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditarExportador{{ transferencia.id }}" data-bs-toggle="tooltip" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalEliminarExportador{{ transferencia.id }}" data-bs-toggle="tooltip" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if active_tab == 'exportador' and is_paginated %}
                    <div class="pagination-container mt-4">
                        <nav aria-label="Navegación de transferencias">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=exportador&page=1" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=exportador&page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% endif %}

                                <li class="page-item active" aria-current="page">
                                    <span class="page-link">
                                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=exportador&page={{ page_obj.next_page_number }}" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=exportador&page={{ page_obj.paginator.num_pages }}" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Aduana Tab -->
        <div class="tab-pane fade {% if active_tab == 'aduana' %}show active{% endif %}" id="aduana" role="tabpanel" aria-labelledby="aduana-tab">
            <div class="card content-card">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                    <h5 class="card-title mb-2 mb-md-0">
                        <i class="bi bi-building me-2"></i>Transferencias a Agencias de Aduana
                    </h5>
                    <div class="actions">
                        <button type="button" class="btn btn-primary btn-with-icon" data-bs-toggle="modal" data-bs-target="#modalCrearAduana">
                            <i class="bi bi-plus-circle"></i> Nueva Transferencia
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-filters d-flex flex-column flex-md-row justify-content-between mb-3">
                        <div class="d-flex flex-wrap gap-2 mb-2 mb-md-0">
                            <div class="input-group search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchAduana" placeholder="Buscar...">
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                                <li><a class="dropdown-item" href="#" data-filter="all">Todas</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="month">Último mes</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="week">Última semana</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="table-responsive table-container">
                        <table class="table table-striped table-hover data-table" id="tablaAduana">
                            <thead>
                                <tr>
                                    <th class="text-center">#</th>
                                    <th>Agencia Aduana</th>
                                    <th>Referencia</th>
                                    <th>Fecha</th>
                                    <th class="text-end">Valor EUR</th>
                                    <th>Concepto</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transferencia in transferencias_aduana %}
                                <tr>
                                    <td class="text-center id-column">{{ transferencia.id }}</td>
                                    <td>{{ transferencia.agencia_aduana.nombre }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ transferencia.referencia }}</span>
                                    </td>
                                    <td>{{ transferencia.fecha_transferencia|date:"d/m/Y" }}</td>
                                    <td class="text-end">
                                        <span class="currency-value">{{ transferencia.valor_transferencia|format_currency_eur }}</span>
                                    </td>
                                    <td>
                                        <span class="truncate-text" data-bs-toggle="tooltip" title="{{ transferencia.concepto }}">
                                            {{ transferencia.concepto|truncatechars:20 }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditarAduana{{ transferencia.id }}" data-bs-toggle="tooltip" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalEliminarAduana{{ transferencia.id }}" data-bs-toggle="tooltip" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if active_tab == 'aduana' and is_paginated %}
                    <div class="pagination-container mt-4">
                        <nav aria-label="Navegación de transferencias">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=aduana&page=1" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=aduana&page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% endif %}

                                <li class="page-item active" aria-current="page">
                                    <span class="page-link">
                                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=aduana&page={{ page_obj.next_page_number }}" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=aduana&page={{ page_obj.paginator.num_pages }}" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Carga Tab -->
        <div class="tab-pane fade {% if active_tab == 'carga' %}show active{% endif %}" id="carga" role="tabpanel" aria-labelledby="carga-tab">
            <div class="card content-card">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                    <h5 class="card-title mb-2 mb-md-0">
                        <i class="bi bi-box-seam me-2"></i>Transferencias a Agencias de Carga
                    </h5>
                    <div class="actions">
                        <button type="button" class="btn btn-primary btn-with-icon" data-bs-toggle="modal" data-bs-target="#modalCrearCarga">
                            <i class="bi bi-plus-circle"></i> Nueva Transferencia
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-filters d-flex flex-column flex-md-row justify-content-between mb-3">
                        <div class="d-flex flex-wrap gap-2 mb-2 mb-md-0">
                            <div class="input-group search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchCarga" placeholder="Buscar...">
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                                <li><a class="dropdown-item" href="#" data-filter="all">Todas</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="month">Último mes</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="week">Última semana</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="table-responsive table-container">
                        <table class="table table-striped table-hover data-table" id="tablaCarga">
                            <thead>
                                <tr>
                                    <th class="text-center">#</th>
                                    <th>Agencia Carga</th>
                                    <th>Referencia</th>
                                    <th>Fecha</th>
                                    <th class="text-end">Valor USD</th>
                                    <th class="text-end">Valor EUR</th>
                                    <th class="text-end">TRM</th>
                                    <th>Concepto</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transferencia in transferencias_carga %}
                                <tr>
                                    <td class="text-center id-column">{{ transferencia.id }}</td>
                                    <td>{{ transferencia.agencia_carga.nombre }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ transferencia.referencia }}</span>
                                    </td>
                                    <td>{{ transferencia.fecha_transferencia|date:"d/m/Y" }}</td>
                                    <td class="text-end">
                                        <span class="currency-value">{{ transferencia.valor_transferencia|format_currency }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="currency-value">{{ transferencia.valor_transferencia_eur|format_currency_eur }}</span>
                                    </td>
                                    <td class="text-end">{{ transferencia.trm|floatformat:2 }}</td>
                                    <td>
                                        <span class="truncate-text" data-bs-toggle="tooltip" title="{{ transferencia.concepto }}">
                                            {{ transferencia.concepto|truncatechars:20 }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditarCarga{{ transferencia.id }}" data-bs-toggle="tooltip" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalEliminarCarga{{ transferencia.id }}" data-bs-toggle="tooltip" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if active_tab == 'carga' and is_paginated %}
                    <div class="pagination-container mt-4">
                        <nav aria-label="Navegación de transferencias">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=carga&page=1" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=carga&page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% endif %}

                                <li class="page-item active" aria-current="page">
                                    <span class="page-link">
                                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=carga&page={{ page_obj.next_page_number }}" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=carga&page={{ page_obj.paginator.num_pages }}" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Cliente Tab -->
        <div class="tab-pane fade {% if active_tab == 'cliente' %}show active{% endif %}" id="cliente" role="tabpanel" aria-labelledby="cliente-tab">
            <div class="card content-card">
                <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                    <h5 class="card-title mb-2 mb-md-0">
                        <i class="bi bi-people me-2"></i>Pagos de Clientes
                    </h5>
                    <div class="actions">
                        <button type="button" class="btn btn-primary btn-with-icon" data-bs-toggle="modal" data-bs-target="#modalCrearCliente">
                            <i class="bi bi-plus-circle"></i> Nueva Transferencia
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-filters d-flex flex-column flex-md-row justify-content-between mb-3">
                        <div class="d-flex flex-wrap gap-2 mb-2 mb-md-0">
                            <div class="input-group search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchCliente" placeholder="Buscar...">
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton4" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton4">
                                <li><a class="dropdown-item" href="#" data-filter="all">Todas</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="month">Último mes</a></li>
                                <li><a class="dropdown-item" href="#" data-filter="week">Última semana</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="table-responsive table-container">
                        <table class="table table-striped table-hover data-table" id="tablaCliente">
                            <thead>
                                <tr>
                                    <th class="text-center">#</th>
                                    <th>Cliente</th>
                                    <th>Referencia</th>
                                    <th>Fecha</th>
                                    <th class="text-end">Valor EUR</th>
                                    <th>Concepto</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transferencia in transferencias_cliente %}
                                <tr>
                                    <td class="text-center id-column">{{ transferencia.id }}</td>
                                    <td>{{ transferencia.cliente.nombre }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ transferencia.referencia }}</span>
                                    </td>
                                    <td>{{ transferencia.fecha_transferencia|date:"d/m/Y" }}</td>
                                    <td class="text-end">
                                        <span class="currency-value">{{ transferencia.valor_transferencia|format_currency_eur }}</span>
                                    </td>
                                    <td>
                                        <span class="truncate-text" data-bs-toggle="tooltip" title="{{ transferencia.concepto }}">
                                            {{ transferencia.concepto|truncatechars:20 }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditarCliente{{ transferencia.id }}" data-bs-toggle="tooltip" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalEliminarCliente{{ transferencia.id }}" data-bs-toggle="tooltip" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if active_tab == 'cliente' and is_paginated %}
                    <div class="pagination-container mt-4">
                        <nav aria-label="Navegación de transferencias">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=cliente&page=1" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=cliente&page={{ page_obj.previous_page_number }}" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Primera">
                                            <span aria-hidden="true">&laquo;&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                {% endif %}

                                <li class="page-item active" aria-current="page">
                                    <span class="page-link">
                                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=cliente&page={{ page_obj.next_page_number }}" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?tab=cliente&page={{ page_obj.paginator.num_pages }}" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Última">
                                            <span aria-hidden="true">&raquo;&raquo;</span>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->

<!-- Exportador Create Modal -->
<div class="modal fade" id="modalCrearExportador" tabindex="-1" aria-labelledby="modalCrearExportadorLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:crear_transferencia_exportador' %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCrearExportadorLabel">
                        <i class="bi bi-truck me-2"></i>Nueva Transferencia a Exportador
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exportador" class="form-label">Exportador <span class="text-danger">*</span></label>
                        <select class="form-select" id="exportador" name="exportador" required>
                            <option value="">Seleccionar Exportador</option>
                            {% for exportador in exportadores %}
                            <option value="{{ exportador.id }}">{{ exportador.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione un exportador.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia" name="referencia" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia" name="fecha_transferencia" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia" class="form-label">Valor USD <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia" name="valor_transferencia" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia_eur" class="form-label">Valor EUR <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia_eur" name="valor_transferencia_eur" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                            <div class="form-text trm-calculation"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto" name="concepto" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Aduana Create Modal -->
<div class="modal fade" id="modalCrearAduana" tabindex="-1" aria-labelledby="modalCrearAduanaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:crear_transferencia_aduana' %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCrearAduanaLabel">
                        <i class="bi bi-building me-2"></i>Nueva Transferencia a Agencia de Aduana
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="agencia_aduana" class="form-label">Agencia de Aduana <span class="text-danger">*</span></label>
                        <select class="form-select" id="agencia_aduana" name="agencia_aduana" required>
                            <option value="">Seleccionar Agencia de Aduana</option>
                            {% for agencia in agencias_aduana %}
                            <option value="{{ agencia.id }}">{{ agencia.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione una agencia de aduana.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia" name="referencia" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia" name="fecha_transferencia" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="mb-3">
                        <label for="valor_transferencia" class="form-label">Valor de Transferencia (EUR) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia" name="valor_transferencia" required>
                            <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto" name="concepto" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Carga Create Modal -->
<div class="modal fade" id="modalCrearCarga" tabindex="-1" aria-labelledby="modalCrearCargaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:crear_transferencia_carga' %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCrearCargaLabel">
                        <i class="bi bi-box-seam me-2"></i>Nueva Transferencia a Agencia de Carga
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="agencia_carga" class="form-label">Agencia de Carga <span class="text-danger">*</span></label>
                        <select class="form-select" id="agencia_carga" name="agencia_carga" required>
                            <option value="">Seleccionar Agencia de Carga</option>
                            {% for agencia in agencias_carga %}
                            <option value="{{ agencia.id }}">{{ agencia.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione una agencia de carga.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia" name="referencia" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia" name="fecha_transferencia" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia" class="form-label">Valor USD <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia" name="valor_transferencia" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia_eur" class="form-label">Valor EUR <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia_eur" name="valor_transferencia_eur" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                            <div class="form-text trm-calculation"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto" name="concepto" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit and Delete Modals for Exportador -->
{% for transferencia in transferencias_exportador %}
<!-- Edit Modal -->
<div class="modal fade" id="modalEditarExportador{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEditarExportadorLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:editar_transferencia_exportador' transferencia.id %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarExportadorLabel{{ transferencia.id }}">
                        <i class="bi bi-truck me-2"></i>Editar Transferencia a Exportador
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exportador{{ transferencia.id }}" class="form-label">Exportador <span class="text-danger">*</span></label>
                        <select class="form-select" id="exportador{{ transferencia.id }}" name="exportador" required>
                            {% for exportador in exportadores %}
                            <option value="{{ exportador.id }}" {% if exportador.id == transferencia.exportador.id %}selected{% endif %}>{{ exportador.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione un exportador.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia{{ transferencia.id }}" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia{{ transferencia.id }}" name="referencia" value="{{ transferencia.referencia }}" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia{{ transferencia.id }}" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia{{ transferencia.id }}" name="fecha_transferencia" value="{{ transferencia.fecha_transferencia|date:'Y-m-d' }}" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia{{ transferencia.id }}" class="form-label">Valor USD <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia{{ transferencia.id }}" name="valor_transferencia" value="{{ transferencia.valor_transferencia|stringformat:'g' }}" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia_eur{{ transferencia.id }}" class="form-label">Valor EUR <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia_eur{{ transferencia.id }}" name="valor_transferencia_eur" value="{{ transferencia.valor_transferencia_eur|stringformat:'g' }}" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                            <div class="form-text trm-calculation"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto{{ transferencia.id }}" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto{{ transferencia.id }}" name="concepto" rows="3">{{ transferencia.concepto }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="modalEliminarExportador{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEliminarExportadorLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:eliminar_transferencia_exportador' transferencia.id %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarExportadorLabel{{ transferencia.id }}">
                        <i class="bi bi-trash me-2"></i>Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar la transferencia <strong>{{ transferencia.referencia }}</strong> al exportador <strong>{{ transferencia.exportador.nombre }}</strong>?</p>
                    <p class="text-danger">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Edit and Delete Modals for Aduana -->
{% for transferencia in transferencias_aduana %}
<!-- Edit Modal -->
<div class="modal fade" id="modalEditarAduana{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEditarAduanaLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:editar_transferencia_aduana' transferencia.id %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarAduanaLabel{{ transferencia.id }}">
                        <i class="bi bi-building me-2"></i>Editar Transferencia a Agencia de Aduana
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="agencia_aduana{{ transferencia.id }}" class="form-label">Agencia de Aduana <span class="text-danger">*</span></label>
                        <select class="form-select" id="agencia_aduana{{ transferencia.id }}" name="agencia_aduana" required>
                            {% for agencia in agencias_aduana %}
                            <option value="{{ agencia.id }}" {% if agencia.id == transferencia.agencia_aduana.id %}selected{% endif %}>{{ agencia.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione una agencia de aduana.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia{{ transferencia.id }}" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia{{ transferencia.id }}" name="referencia" value="{{ transferencia.referencia }}" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia{{ transferencia.id }}" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia{{ transferencia.id }}" name="fecha_transferencia" value="{{ transferencia.fecha_transferencia|date:'Y-m-d' }}" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="mb-3">
                        <label for="valor_transferencia{{ transferencia.id }}" class="form-label">Valor de Transferencia (EUR) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia{{ transferencia.id }}" name="valor_transferencia" value="{{ transferencia.valor_transferencia|stringformat:'g' }}" required>
                            <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto{{ transferencia.id }}" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto{{ transferencia.id }}" name="concepto" rows="3">{{ transferencia.concepto }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="modalEliminarAduana{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEliminarAduanaLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:eliminar_transferencia_aduana' transferencia.id %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarAduanaLabel{{ transferencia.id }}">
                        <i class="bi bi-trash me-2"></i>Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar la transferencia <strong>{{ transferencia.referencia }}</strong> a la agencia de aduana <strong>{{ transferencia.agencia_aduana.nombre }}</strong>?</p>
                    <p class="text-danger">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Edit and Delete Modals for Carga -->
{% for transferencia in transferencias_carga %}
<!-- Edit Modal -->
<div class="modal fade" id="modalEditarCarga{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEditarCargaLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:editar_transferencia_carga' transferencia.id %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarCargaLabel{{ transferencia.id }}">
                        <i class="bi bi-box-seam me-2"></i>Editar Transferencia a Agencia de Carga
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="agencia_carga{{ transferencia.id }}" class="form-label">Agencia de Carga <span class="text-danger">*</span></label>
                        <select class="form-select" id="agencia_carga{{ transferencia.id }}" name="agencia_carga" required>
                            {% for agencia in agencias_carga %}
                            <option value="{{ agencia.id }}" {% if agencia.id == transferencia.agencia_carga.id %}selected{% endif %}>{{ agencia.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione una agencia de carga.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia{{ transferencia.id }}" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia{{ transferencia.id }}" name="referencia" value="{{ transferencia.referencia }}" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia{{ transferencia.id }}" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia{{ transferencia.id }}" name="fecha_transferencia" value="{{ transferencia.fecha_transferencia|date:'Y-m-d' }}" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia{{ transferencia.id }}" class="form-label">Valor USD <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia{{ transferencia.id }}" name="valor_transferencia" value="{{ transferencia.valor_transferencia|stringformat:'g' }}" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="valor_transferencia_eur{{ transferencia.id }}" class="form-label">Valor EUR <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia_eur{{ transferencia.id }}" name="valor_transferencia_eur" value="{{ transferencia.valor_transferencia_eur|stringformat:'g' }}" required>
                                <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                            </div>
                            <div class="form-text trm-calculation"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto{{ transferencia.id }}" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto{{ transferencia.id }}" name="concepto" rows="3">{{ transferencia.concepto }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="modalEliminarCarga{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEliminarCargaLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:eliminar_transferencia_carga' transferencia.id %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarCargaLabel{{ transferencia.id }}">
                        <i class="bi bi-trash me-2"></i>Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar la transferencia <strong>{{ transferencia.referencia }}</strong> a la agencia de carga <strong>{{ transferencia.agencia_carga.nombre }}</strong>?</p>
                    <p class="text-danger">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Exportador Balance Modal -->
<div class="modal fade" id="modalBalanceExportador" tabindex="-1" aria-labelledby="modalBalanceExportadorLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceExportadorLabel">
                    <i class="bi bi-truck me-2"></i>Balance de Exportadores
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Exportador</th>
                                <th class="text-end">Saldo Disponible USD</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_exportador %}
                            <tr>
                                <td>{{ balance.exportador.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|format_currency }}</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_exportadores|format_currency }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Aduana Balance Modal -->
<div class="modal fade" id="modalBalanceAduana" tabindex="-1" aria-labelledby="modalBalanceAduanaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceAduanaLabel">
                    <i class="bi bi-building me-2"></i>Balance de Agencias de Aduana
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Agencia Aduana</th>
                                <th class="text-end">Saldo Disponible USD</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_aduana %}
                            <tr>
                                <td>{{ balance.agencia_aduana.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|format_currency_eur }}</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_aduanas|format_currency_eur }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Carga Balance Modal -->
<div class="modal fade" id="modalBalanceCarga" tabindex="-1" aria-labelledby="modalBalanceCargaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceCargaLabel">
                    <i class="bi bi-box-seam me-2"></i>Balance de Agencias de Carga
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Agencia Carga</th>
                                <th class="text-end">Saldo Disponible USD</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_carga %}
                            <tr>
                                <td>{{ balance.agencia_carga.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|format_currency }}</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_cargas|format_currency }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Cliente Create Modal -->
<div class="modal fade" id="modalCrearCliente" tabindex="-1" aria-labelledby="modalCrearClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:crear_transferencia_cliente' %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCrearClienteLabel">
                        <i class="bi bi-people me-2"></i>Nueva Transferencia de Cliente
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cliente" class="form-label">Cliente <span class="text-danger">*</span></label>
                        <select class="form-select" id="cliente" name="cliente" required>
                            <option value="">Seleccionar Cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione un cliente.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia" name="referencia" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia" name="fecha_transferencia" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="mb-3">
                        <label for="valor_transferencia" class="form-label">Valor EUR <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia" name="valor_transferencia" required>
                            <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto" name="concepto" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit and Delete Modals for Cliente -->
{% for transferencia in transferencias_cliente %}
<!-- Edit Modal -->
<div class="modal fade" id="modalEditarCliente{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEditarClienteLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:editar_transferencia_cliente' transferencia.id %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarClienteLabel{{ transferencia.id }}">
                        <i class="bi bi-people me-2"></i>Editar Transferencia de Cliente
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cliente{{ transferencia.id }}" class="form-label">Cliente <span class="text-danger">*</span></label>
                        <select class="form-select" id="cliente{{ transferencia.id }}" name="cliente" required>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if cliente.id == transferencia.cliente.id %}selected{% endif %}>{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Por favor seleccione un cliente.</div>
                    </div>
                    <div class="mb-3">
                        <label for="referencia{{ transferencia.id }}" class="form-label">Referencia <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="referencia{{ transferencia.id }}" name="referencia" value="{{ transferencia.referencia }}" required>
                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fecha_transferencia{{ transferencia.id }}" class="form-label">Fecha de Transferencia <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_transferencia{{ transferencia.id }}" name="fecha_transferencia" value="{{ transferencia.fecha_transferencia|date:'Y-m-d' }}" required>
                        <div class="invalid-feedback">Por favor ingrese una fecha válida.</div>
                    </div>
                    <div class="mb-3">
                        <label for="valor_transferencia{{ transferencia.id }}" class="form-label">Valor EUR <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="number" step="0.01" min="0" class="form-control" id="valor_transferencia{{ transferencia.id }}" name="valor_transferencia" value="{{ transferencia.valor_transferencia|stringformat:'g' }}" required>
                            <div class="invalid-feedback">Por favor ingrese un valor válido.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="concepto{{ transferencia.id }}" class="form-label">Concepto</label>
                        <textarea class="form-control" id="concepto{{ transferencia.id }}" name="concepto" rows="3">{{ transferencia.concepto }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="modalEliminarCliente{{ transferencia.id }}" tabindex="-1" aria-labelledby="modalEliminarClienteLabel{{ transferencia.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'importacion:eliminar_transferencia_cliente' transferencia.id %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarClienteLabel{{ transferencia.id }}">
                        <i class="bi bi-trash me-2"></i>Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar la transferencia <strong>{{ transferencia.referencia }}</strong> del cliente <strong>{{ transferencia.cliente.nombre }}</strong>?</p>
                    <p class="text-danger">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Cliente Balance Modal -->
<div class="modal fade" id="modalBalanceCliente" tabindex="-1" aria-labelledby="modalBalanceClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalBalanceClienteLabel">
                    <i class="bi bi-people me-2"></i>Balance de Clientes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th class="text-end">Saldo Disponible EUR</th>
                                <th class="text-center">Última Actualización</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances_cliente %}
                            <tr>
                                <td>{{ balance.cliente.nombre }}</td>
                                <td class="text-end">{{ balance.saldo_disponible|floatformat:2 }} €</td>
                                <td class="text-center">{{ balance.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No hay balances registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-end">Total:</th>
                                <th class="text-end">{{ total_balance_clientes|default:"0.00"|floatformat:2 }} €</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Set the active tab based on the URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        
        if (activeTab) {
            $(`#${activeTab}-tab`).tab('show');
        }
        
        // Update tab parameter when changing tabs (server-side reload)
        $('.nav-pills button').on('click', function (e) {
            const targetId = $(this).attr('id').replace('-tab', '');
            window.location.href = `?tab=${targetId}`;
            e.preventDefault(); // Prevent the default tab switching behavior
        });
        
        // Initialize DataTables with responsive configuration
        function initDataTable(tableId, columnsConfig) {
            return $(`#${tableId}`).DataTable({
                paging: false, // Disable DataTables pagination (using Django's)
                searching: true,
                ordering: true,
                info: true,
                responsive: true,
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Buscar...",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    infoEmpty: "Mostrando 0 a 0 de 0 registros",
                    infoFiltered: "(filtrado de _MAX_ registros totales)",
                    zeroRecords: "No se encontraron registros coincidentes",
                    emptyTable: "No hay datos disponibles en la tabla"
                },
                columnDefs: columnsConfig,
                responsive: {
                    details: {
                        type: 'column',
                        target: 'tr'
                    }
                }
            });
        }
        
        // Initialize DataTables for each tab with specific column configurations
        const tablaExportador = initDataTable('tablaExportador', [
            { targets: [0, 9], orderable: false },
            { targets: [4, 5, 6, 8], className: 'text-end' }
        ]);
        
        const tablaAduana = initDataTable('tablaAduana', [
            { targets: [0, 6], orderable: false },
            { targets: [4], className: 'text-end' }
        ]);
        
        const tablaCarga = initDataTable('tablaCarga', [
            { targets: [0, 8], orderable: false },
            { targets: [4, 5, 6], className: 'text-end' }
        ]);
        
        const tablaCliente = initDataTable('tablaCliente', [
            { targets: [0, 6], orderable: false },
            { targets: [4], className: 'text-end' }
        ]);
        
        // Connect search boxes to DataTables
        $('#searchExportador').on('keyup', function() {
            tablaExportador.search(this.value).draw();
        });
        
        $('#searchAduana').on('keyup', function() {
            tablaAduana.search(this.value).draw();
        });
        
        $('#searchCarga').on('keyup', function() {
            tablaCarga.search(this.value).draw();
        });
        
        $('#searchCliente').on('keyup', function() {
            tablaCliente.search(this.value).draw();
        });
        
        // TRM calculation for Exportador and Agencia de Carga forms
        function setupTrmCalculation(usdSelector, eurSelector, trmDisplaySelector) {
            const usdInput = $(usdSelector);
            const eurInput = $(eurSelector);
            const trmDisplay = $(trmDisplaySelector);
            
            function calculateTrm() {
                const usdValue = parseFloat(usdInput.val()) || 0;
                const eurValue = parseFloat(eurInput.val()) || 0;
                
                if (usdValue > 0 && eurValue > 0) {
                    const trm = usdValue / eurValue;
                    trmDisplay.html(`TRM calculada: ${trm.toFixed(5)}`);
                } else {
                    trmDisplay.html('');
                }
            }
            
            usdInput.on('input', calculateTrm);
            eurInput.on('input', calculateTrm);
            
            // Initial calculation if values exist
            calculateTrm();
        }
        
        // Setup TRM calculation for create forms
        setupTrmCalculation('#modalCrearExportador #valor_transferencia', 
                           '#modalCrearExportador #valor_transferencia_eur', 
                           '#modalCrearExportador .trm-calculation');
        
        setupTrmCalculation('#modalCrearCarga #valor_transferencia', 
                           '#modalCrearCarga #valor_transferencia_eur', 
                           '#modalCrearCarga .trm-calculation');
        
        // Setup TRM calculation for edit forms
        {% for transferencia in transferencias_exportador %}
            setupTrmCalculation('#valor_transferencia{{ transferencia.id }}', 
                               '#valor_transferencia_eur{{ transferencia.id }}', 
                               '#modalEditarExportador{{ transferencia.id }} .trm-calculation');
        {% endfor %}
        
        {% for transferencia in transferencias_carga %}
            setupTrmCalculation('#valor_transferencia{{ transferencia.id }}', 
                               '#valor_transferencia_eur{{ transferencia.id }}', 
                               '#modalEditarCarga{{ transferencia.id }} .trm-calculation');
        {% endfor %}
        
        // Form validation
        (function () {
            'use strict'
            
            // Fetch all forms we want to apply validation styles to
            const forms = document.querySelectorAll('.needs-validation')
            
            // Loop over them and prevent submission
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        } else {
                            // Show spinner when form is valid and submitting
                            const submitBtn = form.querySelector('button[type="submit"]');
                            const spinner = submitBtn.querySelector('.spinner-border');
                            if (spinner) {
                                spinner.classList.remove('d-none');
                                submitBtn.setAttribute('disabled', true);
                            }
                        }
                        
                        form.classList.add('was-validated')
                    }, false)
                })
        })()
    });
</script>
{% endblock %}