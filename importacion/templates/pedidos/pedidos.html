{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% if pedido %}Editar Pedido #{{ pedido.id }}{% else %}Nuevo Pedido{% endif %}</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/pedidos/pedidos.css' %}">
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <i class="fas fa-box"></i>
                {% if pedido %}Pedido #{{ pedido.id }}{% else %}Nuevo Pedido{% endif %}
            </h1>
            <nav class="breadcrumb">
                <a href="{% url 'home' %}"><i class="fas fa-home"></i> Inicio</a> &gt;
                <a href="{% url 'importacion:lista_pedidos' %}"><i class="fas fa-boxes"></i> Pedidos</a> &gt;
                <span>{% if pedido %}Pedido #{{ pedido.id }}{% else %}Nuevo Pedido{% endif %}</span>
            </nav>
        </header>

        <!-- Añadir contenedor para notificaciones -->
        <div id="notifications-container">
            {% if messages %}
                {% for message in messages %}
                    <div class="notification {% if message.tags %}{{ message.tags }}{% endif %}">
                        <span class="notification-message">{{ message }}</span>
                        <button type="button" class="close-notification">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="main-content">
            <!-- Unified Form -->
            <form id="unified-form" method="post" action="{% if pedido %}{% url 'importacion:guardar_detalles_batch' pedido.id %}{% else %}{% url 'importacion:guardar_pedido' %}{% endif %}">
                {% csrf_token %}
                
                <!-- Order Information Section -->
                <section class="order-info">
                    <div class="section-header">
                        <h2><i class="fas fa-info-circle"></i> Información del Pedido</h2>
                        <div class="action-buttons">
                            {% if pedido %}
                                <button type="button" id="enviar-solicitud-btn" class="btn btn-success" data-url="{% url 'importacion:solicitar_pedido' pedido.id %}">
                                    <i class="fas fa-paper-plane"></i> Enviar solicitud
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="exportador">Exportador:</label>
                            <select id="exportador" name="exportador" required>
                                <option value="">Seleccionar Exportador</option>
                                {% for exportador in exportadores %}
                                    <option value="{{ exportador.id }}" {% if pedido and pedido.exportador.id == exportador.id %}selected{% endif %}>
                                        {{ exportador.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fecha_entrega">Fecha de Entrega:</label>
                            <input type="date" id="fecha_entrega" name="fecha_entrega" value="{{ pedido.fecha_entrega|date:'Y-m-d' }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="awb">AWB:</label>
                            <input type="text" id="awb" name="awb" value="{{ pedido.awb|default:'' }}" maxlength="12">
                        </div>
                        
                        <div class="form-group">
                            <label for="numero_factura">Número Factura:</label>
                            <input type="text" id="numero_factura" name="numero_factura" value="{{ pedido.numero_factura|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="numero_nc">Número NC:</label>
                            <input type="text" id="numero_nc" name="numero_nc" value="{{ pedido.numero_nc|default:'' }}">
                            <div class="error-message" id="numero_nc_error"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="observaciones">Observaciones:</label>
                            <textarea id="observaciones" name="observaciones">{{ pedido.observaciones|default:'' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="calculated-fields">
                        {% if pedido %}
                            <div class="calc-field">
                                <span class="label">Semana:</span>
                                <span class="value">{{ pedido.semana }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Cajas Solicitadas:</span>
                                <span class="value">{{ pedido.total_cajas_solicitadas|default:0 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Total Cajas Recibidas:</span>
                                <span class="value">{{ pedido.total_cajas_recibidas|default:0 }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Valor Total Factura USD:</span>
                                <span class="value">{{ pedido.valor_total_factura_usd|format_currency }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Valor Total NC USD:</span>
                                <span class="value">{{ pedido.valor_total_nc_usd|format_currency }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Estado del Pedido:</span>
                                <span class="value">{{ pedido.estado_pedido }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Pagado:</span>
                                <span class="value">{{ pedido.pagado|yesno:"Sí,No" }}</span>
                            </div>
                            <div class="calc-field">
                                <span class="label">Monto Pendiente USD:</span>
                                <span class="value">{{ pedido.monto_pendiente|format_currency}}</span>
                            </div>
                        {% endif %}
                    </div>
                </section>
                
                <!-- Order Details Section (if editing an existing order) -->
                {% if pedido %}
                    <section class="order-details">
                        <div class="section-header">
                            <h2><i class="fas fa-list"></i> Detalles del Pedido</h2>
                            <div class="action-buttons">
                                <div class="copy-boxes-container">
                                    <label for="copy-boxes-checkbox" class="copy-boxes-label">
                                        <input type="checkbox" id="copy-boxes-checkbox">
                                        Copiar cajas solicitadas a recibidas
                                    </label>
                                </div>
                                <button type="button" id="add-detail-btn" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Agregar Detalle
                                </button>
                            </div>
                        </div>
                        
                        <div id="details-container">
                            <div id="new-details-container">
                                <!-- Aquí se añadirán dinámicamente los nuevos detalles -->
                            </div>
                            
                            <table id="details-table" class="details-table">
                                <thead>
                                    <tr>
                                        <th>Presentación</th>
                                        <th>Cajas Solicitadas</th>
                                        <th>Cajas Recibidas</th>
                                        <th>Valor Caja USD</th>
                                        <th>No Cajas NC</th>
                                        <th>NC Manual USD</th>
                                        <th>Total USD</th>
                                        <th>Total EUR</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for detalle in detalles %}
                                    <tr class="detail-row" data-id="{{ detalle.id }}">
                                        <td>
                                            <select name="detalle_{{ detalle.id }}_presentacion" required class="presentacion-select">
                                                {% for presentacion in presentaciones %}
                                                    <option value="{{ presentacion.id }}" {% if detalle.presentacion and detalle.presentacion.id == presentacion.id %}selected{% endif %}>
                                                        {{ presentacion.fruta.nombre }} - {{ presentacion.kilos }} Kg
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_cajas_solicitadas"
                                                   value="{{ detalle.cajas_solicitadas|default:'0' }}" min="0">
                                            <button type="button" class="btn-copy-individual" title="Copiar a cajas recibidas">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_cajas_recibidas"
                                                   value="{{ detalle.cajas_recibidas|default:'0' }}" min="0" class="cajas-recibidas">
                                        </td>
                                        <td>
                                            <input type="number" name="detalle_{{ detalle.id }}_valor_x_caja_usd"
                                                   value="{{ detalle.valor_x_caja_usd_str|default:detalle.valor_x_caja_usd|default:'0.00' }}" min="0" step="0.01" class="valor-caja-usd">
                                        </td>
                                        <td class="nc-field-container">
                                            <input type="number" name="detalle_{{ detalle.id }}_no_cajas_nc"
                                                   value="{{ detalle.no_cajas_nc_str|default:detalle.no_cajas_nc|default:'0.0' }}" min="0" step="0.1" class="no-cajas-nc">
                                            <div class="error-message"></div>
                                        </td>
                                        <td class="nc-manual-field-container">
                                            <input type="number" name="detalle_{{ detalle.id }}_valor_nc_usd_manual"
                                                   value="{{ detalle.valor_nc_usd_manual_str|default:detalle.valor_nc_usd_manual|default:'0.00' }}" min="0" step="0.01" class="valor-nc-manual">
                                            <div class="error-message"></div>
                                        </td>
                                        <td>
                                            <div class="valor-x-producto">{{ detalle.valor_x_producto|format_currency }}</div>
                                        </td>
                                        <td>
                                            <div class="valor-x-producto-eur">
                                                {% if detalle.valor_x_producto_eur and detalle.valor_x_producto_eur > 0 %}
                                                    {{ detalle.valor_x_producto_eur|format_currency_eur }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="actions-cell">
                                            <button type="button" class="btn-icon btn-delete" onclick="removeDetailRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <div class="empty-state" {% if detalles %}style="display:none"{% endif %}>
                                <p>No hay detalles para este pedido. Haga clic en "Agregar Detalle" para añadir uno.</p>
                            </div>
                        </div>
                    </section>
                {% endif %}

                <!-- Unified Save Button -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-lg" id="save-all-btn">
                        <i class="fas fa-save"></i> Guardar Todo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let newDetailCounter = 0;
        const exportadorId = {% if pedido.exportador %}{{ pedido.exportador.id }}{% else %}null{% endif %};
        let isFormSubmitting = false;
        
        // Función para deshabilitar el botón de guardar
        function disableSaveButton() {
            const saveBtn = document.getElementById('save-all-btn');
            const originalText = saveBtn.innerHTML;
            
            isFormSubmitting = true;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            saveBtn.classList.add('loading');
            
            // Deshabilitar también otros botones de acción
            const enviarBtn = document.getElementById('enviar-solicitud-btn');
            if (enviarBtn) {
                enviarBtn.disabled = true;
            }
            
            const addDetailBtn = document.getElementById('add-detail-btn');
            if (addDetailBtn) {
                addDetailBtn.disabled = true;
            }
        }
        
        // Función para rehabilitar el botón de guardar (en caso de error)
        function enableSaveButton() {
            const saveBtn = document.getElementById('save-all-btn');
            
            isFormSubmitting = false;
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Todo';
            saveBtn.classList.remove('loading');
            
            // Rehabilitar también otros botones de acción
            const enviarBtn = document.getElementById('enviar-solicitud-btn');
            if (enviarBtn) {
                enviarBtn.disabled = false;
            }
            
            const addDetailBtn = document.getElementById('add-detail-btn');
            if (addDetailBtn) {
                addDetailBtn.disabled = false;
            }
        }

        // Template for new detail row
        const newDetailRowTemplate = `
            <tr class="detail-row new-detail">
                <td>
                    <select name="new_INDEX_presentacion" required class="presentacion-select">
                        <option value="">Seleccionar Presentación</option>
                        {% for presentacion in presentaciones %}
                            <option value="{{ presentacion.id }}">
                                {{ presentacion.fruta.nombre }} - {{ presentacion.kilos }} Kg
                            </option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <input type="number" name="new_INDEX_cajas_solicitadas" value="0" min="0">
                    <button type="button" class="btn-copy-individual" title="Copiar a cajas recibidas">
                        <i class="fas fa-copy"></i>
                    </button>
                </td>
                <td>
                    <input type="number" name="new_INDEX_cajas_recibidas" value="0" min="0" class="cajas-recibidas">
                </td>
                <td>
                    <input type="number" name="new_INDEX_valor_x_caja_usd" value="0" min="0" step="0.01" class="valor-caja-usd">
                </td>
                <td class="nc-field-container">
                    <input type="number" name="new_INDEX_no_cajas_nc" value="0" min="0" step="0.1" class="no-cajas-nc">
                    <div class="error-message"></div>
                </td>
                <td class="nc-manual-field-container">
                    <input type="number" name="new_INDEX_valor_nc_usd_manual" value="0" min="0" step="0.01" class="valor-nc-manual">
                    <div class="error-message"></div>
                </td>
                <td>
                    <div class="valor-x-producto">$ 0.00</div>
                </td>
                <td>
                    <div class="valor-x-producto-eur">-</div>
                </td>
                <td class="actions-cell">
                    <button type="button" class="btn-icon btn-delete" onclick="removeDetailRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;

        function addNewDetailRow() {
            // Crear nueva fila a partir de la plantilla
            let newRow = newDetailRowTemplate.replace(/INDEX/g, newDetailCounter);

            // Añadir la fila al inicio de la tabla
            const tableBody = document.querySelector('#details-table tbody');
            tableBody.insertAdjacentHTML('afterbegin', newRow);

            // Add event listeners to the new row
            const newRowElement = tableBody.firstElementChild;
            addValidationListeners(newRowElement);
            addPriceLoaderListener(newRowElement); // Añadir el listener para cargar precios
            addCopyButtonListener(newRowElement); // Añadir el listener para botón de copiar individual
            handleZeroFields(newRowElement); // Aplicar manejo de campos cero

            newDetailCounter++;

            // Show the table if it's hidden
            document.querySelector('.empty-state').style.display = 'none';
            document.getElementById('details-table').style.display = 'table';
        }

        // Función para cargar el precio de una presentación
        function loadPresentationPrice(presentacionSelect) {
            const exportadorSelect = document.getElementById('exportador');
            const exportadorId = exportadorSelect.value;
            const presentacionId = presentacionSelect.value;

            if (!presentacionId || !exportadorId) {
                return; // Si no hay una presentación o exportador seleccionado, no hacer nada
            }

            // Encontrar el campo de valor_x_caja_usd en la misma fila
            const row = presentacionSelect.closest('tr');
            const valorCajaField = row.querySelector('.valor-caja-usd') || row.querySelector('[name$="_valor_x_caja_usd"]');

            if (!valorCajaField) {
                return; // Si no se encuentra el campo, no hacer nada
            }

            // Mostrar indicador de carga
            valorCajaField.placeholder = "Cargando...";

            // Hacer la solicitud AJAX para obtener el precio
            fetch(`/importacion/api/precio/${presentacionId}/${exportadorId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Actualizar el campo con el precio obtenido
                        valorCajaField.value = data.precio.toFixed(2);
                    } else {
                        // Mostrar un mensaje si no se pudo obtener el precio
                        console.warn('No se pudo obtener el precio:', data.message);
                        valorCajaField.placeholder = "Precio no disponible";
                        valorCajaField.value = "";
                    }
                })
                .catch(error => {
                    console.error('Error al obtener precio:', error);
                    valorCajaField.placeholder = "Error al cargar";
                    valorCajaField.value = "";
                });
        }

        // Función para añadir listener de carga de precios
        function addPriceLoaderListener(element) {
            const presentacionSelect = element.querySelector('.presentacion-select') || element.querySelector('[name$="_presentacion"]');

            if (presentacionSelect) {
                presentacionSelect.addEventListener('change', function() {
                    loadPresentationPrice(this);
                });
            }
        }

        function removeDetailRow(button) {
            const row = button.closest('.detail-row');
            const detailId = row.dataset.id;

            if (detailId) {
                // Si es un detalle existente, agregar un campo oculto para marcarlo como eliminado
                const form = document.getElementById('unified-form');
                const deleteField = document.createElement('input');
                deleteField.type = 'hidden';
                deleteField.name = 'delete_detail_ids';
                deleteField.value = detailId;
                form.appendChild(deleteField);
            }

            // Eliminar la fila
            row.remove();

            // Mostrar mensaje de estado vacío si no hay filas
            if (document.querySelectorAll('#details-table tbody tr').length === 0) {
                document.querySelector('.empty-state').style.display = 'block';
                document.getElementById('details-table').style.display = 'none';
            }
        }

        function validateNCFields() {
            let isValid = true;
            const numeroNC = document.getElementById('numero_nc');
            const numeroNCError = document.getElementById('numero_nc_error');
            let hasNCCajas = false;
            let hasNCManual = false;

            // Check all NC fields (cajas NC)
            document.querySelectorAll('.no-cajas-nc').forEach(function(input) {
                // Make sure we handle "0", "0.0", "0.00" etc. as zero
                const cajaNC = parseFloat(input.value) || 0;
                // Use a small epsilon value to handle floating point precision issues
                if (cajaNC > 0.001) {
                    hasNCCajas = true;

                    // Validate that NC boxes are not greater than received boxes
                    const row = input.closest('tr');
                    const cajasRecibidas = parseInt(row.querySelector('.cajas-recibidas').value) || 0;
                    const errorDiv = input.nextElementSibling;

                    if (cajaNC > cajasRecibidas) {
                        errorDiv.textContent = 'NC no puede ser mayor que cajas recibidas';
                        errorDiv.style.display = 'block';
                        input.classList.add('error-field');
                        isValid = false;
                    } else {
                        errorDiv.style.display = 'none';
                        input.classList.remove('error-field');
                    }
                }
            });
            
            // Check all NC manual fields
            document.querySelectorAll('.valor-nc-manual').forEach(function(input) {
                const ncManualValue = parseFloat(input.value) || 0;
                if (ncManualValue > 0.001) {
                    hasNCManual = true;
                    
                    // Validate against product value
                    const row = input.closest('tr');
                    if (!validateNCManual(input, row)) {
                        isValid = false;
                    }
                }
            });

            // Validate Numero NC if any NC (boxes or manual) exist
            if ((hasNCCajas || hasNCManual) && !numeroNC.value.trim()) {
                numeroNCError.textContent = 'Número NC es requerido cuando hay cajas notas de crédito';
                numeroNCError.style.display = 'block';
                numeroNC.classList.add('error-field');
                isValid = false;
            } else {
                numeroNCError.style.display = 'none';
                numeroNC.classList.remove('error-field');
            }

            return isValid;
        }

        function addValidationListeners(element) {
            // Add listeners to NC fields to validate on change
            const ncField = element.querySelector('.no-cajas-nc');
            const cajasRecibidasField = element.querySelector('.cajas-recibidas');
            const ncManualField = element.querySelector('.valor-nc-manual');
            const valorCajaField = element.querySelector('.valor-caja-usd');

            if (ncField && cajasRecibidasField) {
                // Usar 'input' en vez de 'change' para validación inmediata
                ncField.addEventListener('input', function() {
                    validateNCField(this, cajasRecibidasField);
                });

                // También mantener el evento 'change' para navegadores antiguos
                ncField.addEventListener('change', function() {
                    validateNCField(this, cajasRecibidasField);
                });

                cajasRecibidasField.addEventListener('input', function() {
                    validateNCField(ncField, this);
                    
                    // Añadir validación para Valor Caja USD
                    if (valorCajaField) {
                        validateValorCaja(valorCajaField, this);
                    }
                    
                    updateProductValue(this.closest('tr'));
                });

                cajasRecibidasField.addEventListener('change', function() {
                    validateNCField(ncField, this);
                    
                    // Añadir validación para Valor Caja USD
                    if (valorCajaField) {
                        validateValorCaja(valorCajaField, this);
                    }
                    
                    updateProductValue(this.closest('tr'));
                });
            }
            
            // Add listeners for valor_nc_usd_manual validation
            if (ncManualField && valorCajaField) {
                ncManualField.addEventListener('input', function() {
                    validateNCManual(this, this.closest('tr'));
                });
                
                ncManualField.addEventListener('change', function() {
                    validateNCManual(this, this.closest('tr'));
                });
                
                // Update product value when valor_caja changes
                valorCajaField.addEventListener('input', function() {
                    updateProductValue(this.closest('tr'));
                    // Añadir validación para Valor Caja USD
                    const cajasRecibidasField = this.closest('tr').querySelector('.cajas-recibidas');
                    if (cajasRecibidasField) {
                        validateValorCaja(this, cajasRecibidasField);
                    }
                });
                
                valorCajaField.addEventListener('change', function() {
                    updateProductValue(this.closest('tr'));
                    // Añadir validación para Valor Caja USD
                    const cajasRecibidasField = this.closest('tr').querySelector('.cajas-recibidas');
                    if (cajasRecibidasField) {
                        validateValorCaja(this, cajasRecibidasField);
                    }
                });
            }
        }
        
        // Function to update the product value display
        function updateProductValue(row) {
            const cajasRecibidas = parseFloat(row.querySelector('.cajas-recibidas').value) || 0;
            const valorCaja = parseFloat(row.querySelector('.valor-caja-usd').value) || 0;
            const valorProducto = cajasRecibidas * valorCaja;
            
            // Update the displayed value
            row.querySelector('.valor-x-producto').textContent = `$ ${valorProducto.toFixed(2)}`;
            
            // Validate NC manual field since product value might have changed
            const ncManualField = row.querySelector('.valor-nc-manual');
            if (ncManualField) {
                validateNCManual(ncManualField, row);
            }
        }
        
        // Function to validate NC manual field
        function validateNCManual(ncManualField, row) {
            const ncManualValue = parseFloat(ncManualField.value) || 0;
            const errorDiv = ncManualField.nextElementSibling;
            
            // Get current product value (calculated from cajas_recibidas * valor_caja_usd)
            const cajasRecibidas = parseFloat(row.querySelector('.cajas-recibidas').value) || 0;
            const valorCaja = parseFloat(row.querySelector('.valor-caja-usd').value) || 0;
            const valorProducto = cajasRecibidas * valorCaja;
            
            // Calculate valor_nc_usd (NC value from boxes)
            const noCajasNC = parseFloat(row.querySelector('.no-cajas-nc').value) || 0;
            const valorNCUSD = noCajasNC * valorCaja;
            
            // The maximum allowed for manual NC is (product value - box NC value)
            const maxAllowedManualNC = valorProducto - valorNCUSD;
            
            if (ncManualValue > maxAllowedManualNC) {
                errorDiv.textContent = 'NC manual no puede exceder valor restante después de NC por cajas';
                errorDiv.style.display = 'block';
                ncManualField.classList.add('error-field');
                return false;
            } else {
                errorDiv.style.display = 'none';
                ncManualField.classList.remove('error-field');
                return true;
            }
        }

        // Function to validate Valor Caja USD field
        function validateValorCaja(valorCajaField, cajasRecibidasField) {
            const valorCaja = parseFloat(valorCajaField.value) || 0;
            const cajasRecibidas = parseFloat(cajasRecibidasField.value) || 0;
            
            if (cajasRecibidas > 0 && valorCaja === 0) {
                valorCajaField.classList.add('error-field');
                return false;
            } else {
                valorCajaField.classList.remove('error-field');
                return true;
            }
        }

        function updateNumeroNCRequirement() {
            let hasNC = false;
            const numeroNC = document.getElementById('numero_nc');
            const numeroNCError = document.getElementById('numero_nc_error');

            // Check if any NC boxes or manual NC values exist
            document.querySelectorAll('.no-cajas-nc, .valor-nc-manual').forEach(function(input) {
                // Make sure we handle "0", "0.0", "0.00" etc. as zero
                const value = parseFloat(input.value) || 0;
                if (value > 0.001) {
                    hasNC = true;
                }
            });

            // Set requirement for Numero NC
            if (hasNC && !numeroNC.value.trim()) {
                numeroNCError.textContent = 'Número NC es requerido cuando hay notas de crédito';
                numeroNCError.style.display = 'block';
                numeroNC.classList.add('error-field');
            } else {
                numeroNCError.style.display = 'none';
                numeroNC.classList.remove('error-field');
            }
        }

        // Función para copiar valor individual de cajas solicitadas a recibidas
        function copyCajasValue(button) {
            const row = button.closest('tr');
            const cajasSolicitadasInput = row.querySelector('[name$="_cajas_solicitadas"]');
            const cajasRecibidasInput = row.querySelector('[name$="_cajas_recibidas"]');
            
            if (cajasSolicitadasInput && cajasRecibidasInput) {
                // Copiar el valor
                cajasRecibidasInput.value = cajasSolicitadasInput.value;
                
                // Disparar evento input para actualizar cálculos
                const inputEvent = new Event('input', { bubbles: true });
                cajasRecibidasInput.dispatchEvent(inputEvent);
                
                // Mostrar una pequeña animación para feedback visual
                cajasRecibidasInput.classList.add('highlight-field');
                setTimeout(() => {
                    cajasRecibidasInput.classList.remove('highlight-field');
                }, 800);
                
                // Comparar valores para actualizar el resaltado
                compareCajasValues(row);
            }
        }
        
        // Función para manejar los campos con valor cero
        function handleZeroFields(element) {
            // Seleccionar todos los campos numéricos
            const numericInputs = element.querySelectorAll('input[type="number"]');
            
            numericInputs.forEach(input => {
                // Evento focus - Vaciar cuando el valor es 0
                input.addEventListener('focus', function() {
                    // Verificar si el valor actual es 0, 0.0, 0.00, etc.
                    const value = parseFloat(this.value) || 0;
                    if (value === 0) {
                        this.value = '';
                    }
                });
                
                // Evento blur - Restaurar 0 si se deja vacío
                input.addEventListener('blur', function() {
                    if (this.value === '' || this.value === null) {
                        // Usar el paso (step) del input para determinar el formato
                        // Si tiene decimales, mostrar con decimales, sino entero
                        const step = parseFloat(this.getAttribute('step') || 1);
                        if (step < 1) {
                            // Es un campo decimal
                            const decimals = step.toString().split('.')[1].length;
                            this.value = (0).toFixed(decimals);
                        } else {
                            // Es un campo entero
                            this.value = '0';
                        }
                    }
                    const name = this.name;
                    if (name && (name.includes('cajas_solicitadas') || name.includes('cajas_recibidas'))) {
                        compareCajasValues(this.closest('tr'));
                    }
                });
            });
        }
        
        // Función para añadir listener al botón de copia individual
        function addCopyButtonListener(element) {
            const copyButton = element.querySelector('.btn-copy-individual');
            if (copyButton) {
                copyButton.addEventListener('click', function() {
                    copyCajasValue(this);
                });
            }
        }

        // Función para comparar valores entre Cajas Solicitadas y Cajas Recibidas
        function compareCajasValues(row) {
            const cajasSolicitadasInput = row.querySelector('[name$="_cajas_solicitadas"]');
            const cajasRecibidasInput = row.querySelector('[name$="_cajas_recibidas"]');
            
            if (cajasSolicitadasInput && cajasRecibidasInput) {
                const cajasSolicitadas = parseInt(cajasSolicitadasInput.value) || 0;
                const cajasRecibidas = parseInt(cajasRecibidasInput.value) || 0;
                
                if (cajasSolicitadas !== cajasRecibidas) {
                    cajasRecibidasInput.classList.add('cajas-diferentes');
                } else {
                    cajasRecibidasInput.classList.remove('cajas-diferentes');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add event to add detail button
            const addDetailBtn = document.getElementById('add-detail-btn');
            if (addDetailBtn) {
                addDetailBtn.addEventListener('click', function() {
                    addNewDetailRow();
                    document.querySelectorAll('#details-table tbody tr').forEach(function(row) {
                        compareCajasValues(row);
                    });
                });
            }

            // Manejar el botón "Enviar solicitud"
            const enviarSolicitudBtn = document.getElementById('enviar-solicitud-btn');
            if (enviarSolicitudBtn) {
                enviarSolicitudBtn.addEventListener('click', function() {
                    // Verificar si el formulario ya está siendo enviado
                    if (isFormSubmitting || this.disabled) {
                        return false;
                    }
                    
                    // Obtener la URL de solicitar_pedido a la que redirigir después de guardar
                    const redirectUrl = this.getAttribute('data-url');
                    
                    // Crear un input hidden para indicar que se está enviando una solicitud
                    const enviarSolicitudInput = document.createElement('input');
                    enviarSolicitudInput.type = 'hidden';
                    enviarSolicitudInput.name = 'enviar_solicitud';
                    enviarSolicitudInput.value = 'true';
                    
                    // Añadir el input hidden al formulario
                    const form = document.getElementById('unified-form');
                    form.appendChild(enviarSolicitudInput);
                    
                    // Añadir un input hidden con la URL de redirección
                    const redirectInput = document.createElement('input');
                    redirectInput.type = 'hidden';
                    redirectInput.name = 'redirect_url';
                    redirectInput.value = redirectUrl;
                    form.appendChild(redirectInput);
                    
                    // Validar el formulario y enviarlo si es válido
                    let isValid = validateNCFields();
                    
                    // Validar todos los campos de valor caja
                    document.querySelectorAll('.valor-caja-usd').forEach(function(valorCajaField) {
                        const row = valorCajaField.closest('tr');
                        const cajasRecibidasField = row.querySelector('.cajas-recibidas');
                        if (!validateValorCaja(valorCajaField, cajasRecibidasField)) {
                            isValid = false;
                        }
                    });
                    
                    if (isValid) {
                        // Deshabilitar botones antes de enviar
                        disableSaveButton();
                        form.submit();
                    } else {
                        showNotification('Por favor, corrija los errores en el formulario antes de enviar la solicitud.', 'error');
                        // Eliminar los inputs hidden si no se envía el formulario
                        form.removeChild(enviarSolicitudInput);
                        form.removeChild(redirectInput);
                    }
                });
            }

            // Aplicar manejo de campos cero a todos los campos numéricos existentes
            handleZeroFields(document);

            // Agregar evento al checkbox para copiar cajas solicitadas a recibidas
            const copyBoxesCheckbox = document.getElementById('copy-boxes-checkbox');
            if (copyBoxesCheckbox) {
                copyBoxesCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        // Copiar valores de cajas solicitadas a cajas recibidas
                        document.querySelectorAll('#details-table tbody tr').forEach(function(row) {
                            const cajasSolicitadasInput = row.querySelector('[name$="_cajas_solicitadas"]');
                            const cajasRecibidasInput = row.querySelector('[name$="_cajas_recibidas"]');
                            
                            if (cajasSolicitadasInput && cajasRecibidasInput) {
                                // Copiar el valor
                                cajasRecibidasInput.value = cajasSolicitadasInput.value;
                                
                                // Disparar evento input para actualizar cálculos
                                const inputEvent = new Event('input', { bubbles: true });
                                cajasRecibidasInput.dispatchEvent(inputEvent);
                                
                                // Comparar valores para actualizar el resaltado
                                compareCajasValues(row);
                            }
                        });
                        
                        showNotification('Valores de cajas solicitadas copiados a cajas recibidas', 'success');
                    }
                });
            }

            // Add submit handler to validate before submitting
            document.getElementById('unified-form').addEventListener('submit', function(e) {
                const saveBtn = document.getElementById('save-all-btn');
                
                // Verificar si el formulario ya está siendo enviado
                if (saveBtn.disabled) {
                    e.preventDefault();
                    return false;
                }
                
                let isValid = validateNCFields();
                
                // Validar todos los campos de valor caja
                document.querySelectorAll('.valor-caja-usd').forEach(function(valorCajaField) {
                    const row = valorCajaField.closest('tr');
                    const cajasRecibidasField = row.querySelector('.cajas-recibidas');
                    if (!validateValorCaja(valorCajaField, cajasRecibidasField)) {
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    showNotification('Por favor, corrija los errores en el formulario.', 'error');
                    return false;
                }
                
                // Si la validación es exitosa, deshabilitar el botón y mostrar indicador de carga
                disableSaveButton();
            });

            // Add validation listeners to existing rows
            document.querySelectorAll('#details-table .detail-row').forEach(function(row) {
                addValidationListeners(row);
                addPriceLoaderListener(row); // Añadir listeners para cargar precios
                addCopyButtonListener(row);  // Añadir listeners para botones de copia individual
                
                // Initial calculation of product values
                updateProductValue(row);
                
                // Comparar valores para actualizar el resaltado
                compareCajasValues(row);
            });

            // Add listener to numero_nc field
            document.getElementById('numero_nc').addEventListener('input', updateNumeroNCRequirement);

            // Add change listener to exportador for updating all presentation prices if needed
            const exportadorSelect = document.getElementById('exportador');
            exportadorSelect.addEventListener('change', function() {
                document.querySelectorAll('.presentacion-select, [name$="_presentacion"]').forEach(function(select) {
                    if (select.value) {
                        loadPresentationPrice(select);
                    }
                });
            });

            // Initialize estado empty
            if (document.querySelectorAll('#details-table tbody tr').length === 0) {
                document.querySelector('.empty-state').style.display = 'block';
                document.getElementById('details-table').style.display = 'none';
            }

            // Add event listeners to close notification buttons and set auto-close for all notifications
            document.querySelectorAll('.notification').forEach(function(notification) {
                // Set up auto-close timer for all notifications
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => notification.remove(), 500);
                }, 5000);

                // Setup close button
                notification.querySelector('.close-notification').addEventListener('click', function() {
                    notification.remove();
                });
            });
        });
        
        // Function to show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notifications-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span class="notification-message">${message}</span>
                <button type="button" class="close-notification">&times;</button>
            `;
            
            container.appendChild(notification);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
            
            // Setup close button
            notification.querySelector('.close-notification').addEventListener('click', function() {
                notification.remove();
            });
        }
        
        // Detectar si la página se está descargando para evitar rehabilitar el botón
        let isPageUnloading = false;
        window.addEventListener('beforeunload', function() {
            isPageUnloading = true;
        });
        
        // Rehabilitar el botón si hay un error de red o la página no se redirige
        // (esto puede suceder si hay errores de validación del servidor)
        setTimeout(function() {
            if (!isPageUnloading && isFormSubmitting) {
                enableSaveButton();
                showNotification('Hubo un problema al guardar. Por favor, inténtelo de nuevo.', 'error');
            }
        }, 30000); // 30 segundos timeout
    </script>
</body>
</html>